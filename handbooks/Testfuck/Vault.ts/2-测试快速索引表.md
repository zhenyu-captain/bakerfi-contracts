# Vault.ts 测试快速索引表

> 快速查找和定位测试用例

---

## 🔍 按测试结果行号快速索引

| 终端行号 | 测试名称 | 类型 | 关键词 |
|---------|---------|------|-------|
| 6 | Vault Initilization | 功能 | 初始化 |
| 7 | Deposit - Emit Strategy Amount Update | 功能 | 存款,事件 |
| 8 | Deposit - Emit Strategy Deploy | 功能 | 存款,事件 |
| 9 | Deposit 10TH | 功能 | 存款 |
| 10 | Withdraw - 1 brETH | 功能 | 提款 |
| 11 | Deposit - 0 ETH | **安全** | 零值保护 |
| 12 | Withdraw failed not enough brETH | **安全** | 余额不足 |
| 13 | Transfer 10 brETH | 功能 | 代币转账 |
| 14 | Harvest Profit on Rebalance | 功能 | 收益,再平衡 |
| 15 | Withdraw With Service Fees | 功能 | 提款,费用 |
| 16 | Withdraw - Burn all brETH | 功能 | 销毁份额 |
| 17 | Withdraw - Burn all brETH except 10 | 功能 | 部分销毁 |
| 18 | Withdraw - minimum shares should fail | **安全** | 最小份额保护 |
| 19 | Deposit with No Flash Loan Fees 1 | 功能 | 闪电贷 |
| 20 | Withdraw with No Flash Loan Fees | 功能 | 闪电贷 |
| 21 | Adjust Debt with No Flash Loan Fees | 功能 | 债务调整 |
| 22 | Deposit with no Flash Loan Fees 2 | 功能 | 闪电贷 |
| 23 | Deposit with 1% Flash Loan Fees | 功能 | 闪电贷费用 |
| 24 | Multiple Deposits | 功能 | 多用户 |
| 25 | convertToShares - 1ETH | ERC-4626 | 价格转换 |
| 26 | convertToAssets - 1e18 brETH | ERC-4626 | 价格转换 |
| 27 | convertToShares - 1ETH no balance | ERC-4626 | 空金库 |
| 28 | convertToAssets - 1e18 brETH no balance | ERC-4626 | 空金库 |
| 29 | tokenPerAsset - No Balance | ERC-4626 | 空金库 |
| 30 | Deposit Fails when prices outdated | **安全** | 预言机 |
| 31 | Deposit Fails when prices outdated | **安全** | 预言机 |
| 32 | Deposit Success with old prices | **安全** | 预言机边界 |
| 33 | convertToShares with outdated prices | **安全** | 预言机 |
| 34 | convertToAssets with outdated prices | **安全** | 预言机 |
| 35 | tokenPerAsset with outdated prices | **安全** | 预言机 |
| 36 | totalAssets with outdated prices | **安全** | 预言机 |
| 37 | Pause and Unpause | 功能 | 暂停控制 |
| 38 | Withdraw Fails when vault is paused | **安全** | 暂停保护 |
| 39 | Deposit Fails when vault is paused | **安全** | 暂停保护 |
| 40 | Transfer ETH to contract should fail | **安全** | 直接转账保护 |
| 41 | Deposit Success | ERC-4626 | deposit() |
| 42 | Deposit Failed - No Allowance | **安全** | 授权检查 |
| 43 | Deposit Failed - Zero Deposit | **安全** | 零值保护 |
| 44 | Deposit Failed - Zero Receiver | **安全** | 零地址保护 |
| 45 | MaxDeposit | ERC-4626 | maxDeposit() |
| 46 | PreviewDeposit - First Deposit | ERC-4626 | previewDeposit() |
| 47 | PreviewDeposit - Second Deposit | ERC-4626 | previewDeposit() |
| 48 | MaxMint | ERC-4626 | maxMint() |
| 49 | PreviewMint | ERC-4626 | previewMint() |
| 50 | Mint Success | ERC-4626 | mint() |
| 51 | Mint Failed - No Allowance | **安全** | 授权检查 |
| 52 | Mint Failed - Zero Shares | **安全** | 零值保护 |
| 53 | Mint Failed - No Receiver | **安全** | 零地址保护 |
| 54 | MaxWithdraw - Empty Vault | ERC-4626 | maxWithdraw() |
| 55 | MaxWithdraw - Some shares | ERC-4626 | maxWithdraw() |
| 56 | PreviewWithdraw | ERC-4626 | previewWithdraw() |
| 57 | Withdraw Success | ERC-4626 | withdraw() |
| 58 | Withdraw Success - In Name of | ERC-4626 | withdraw() |
| 59 | Withdraw Failed - In name of holder | **安全** | 授权检查 |
| 60 | Withdraw Failed - No Balance | **安全** | 余额检查 |
| 61 | Withdraw Failed - No Balance In Name of | **安全** | 余额检查 |
| 62 | MaxRedeem | ERC-4626 | maxRedeem() |
| 63 | PreviewRedeem | ERC-4626 | previewRedeem() |
| 64 | Redeem Sucess | ERC-4626 | redeem() |
| 65 | When Paused - max functions = 0 | **安全** | 暂停状态 |
| 66 | No Deposit limit - unlimited | ERC-4626 | 无限制模式 |
| 67 | Redeem Sucess - In Name of | ERC-4626 | redeem() |
| 68 | Redeem Failed - In Name of | **安全** | 授权检查 |
| 69 | Rebalance - no balance | 功能 | 再平衡 |
| 70 | Rebalance - Fails when paused | **安全** | 暂停保护 |
| 71 | Withdraw - Invalid Receiver | **安全** | 接收者验证 |
| 72 | Deposit - Account not allowed | **安全** | 白名单 |
| 73 | Withdraw - Account not allowed | **安全** | 白名单 |
| 74 | Deposit 10 Wei - minimum shares | **安全** | 通胀攻击防护 |
| 75 | Deposit Fails - debt > collateral | **安全** | 债务保护 |
| 76 | Rebalance - Generates Revenue | 功能 | 收益生成 |
| 77 | Rebalance - Uncollateralized | 功能 | 无抵押品 |
| 78 | Deposit - under the max | **安全** | 限额检查 |
| 79 | Deposit Failed - over the max | **安全** | 限额检查 |
| 80 | Deposit Failed - second exceeds | **安全** | 累计限额 |
| 81 | Deposit - under the max | **安全** | 限额检查 |
| 82 | Pause - by owner | 治理 | 暂停权限 |
| 83 | Unpause - by owner | 治理 | 恢复权限 |
| 84 | Pauser - Non-Owner cannot pause | **安全** | 权限控制 |
| 85 | Pauser - Non-Pauser cannot unpause | **安全** | 权限控制 |
| 86 | Change Withdrawal Fee ✅ | 治理 | 费用管理 |
| 87 | Withdrawal Fee ❌ | **安全** | 权限验证 |
| 88 | Change Perfornance Fee ✅ | 治理 | 费用管理 |
| 89 | Invalid Perfornance Fee ❌ | **安全** | 参数验证 |
| 90 | Change Fee Receiver ✅ | 治理 | 费用管理 |
| 91 | Owner is no able to update ❌ | **安全** | 权限验证 |
| 92 | Account allowed - empty whitelist ✅ | 治理 | 白名单 |
| 93 | Account not allowed - whitelist ✅ | **安全** | 白名单 |
| 94 | Only Owner - change whitelist ✅ | **安全** | 权限控制 |
| 95 | Fail - enable enabled address ✅ | **安全** | 重复操作 |
| 96 | Fail - disable disabled address ❌ | **安全** | 重复操作 |
| 97 | Change Max Deposit ✅ | 治理 | 限额管理 |
| 98 | Only Owner - change max deposit ❌ | **安全** | 权限验证 |
| 99 | Change Price Max Age ✅ | 治理 | 预言机配置 |
| 100 | Grant Pause Role - grant | 治理 | 角色管理 |
| 101 | Grant Pause Role - cannot pause | **安全** | 角色验证 |
| 102 | Grant Pause Role - non-admin | **安全** | 角色验证 |
| 103 | Grant Pause Role - revoke | 治理 | 角色管理 |

---

## 🎨 按功能类别快速查找

### 💰 存款相关 (Deposit)
- 行 6-9, 11, 19, 22-24, 30-32, 39, 41-44, 46-47, 72, 74-75, 78-81

### 💸 提款相关 (Withdraw/Redeem)
- 行 10-12, 15-18, 20, 38, 54-61, 62-68, 71, 73

### 🔄 再平衡 (Rebalance)
- 行 14, 21, 69-70, 76-77

### 🔮 价格预言机 (Oracle)
- 行 25-29, 30-36, 99

### ⏸️ 暂停功能 (Pause)
- 行 37-39, 65, 70, 82-85, 100-103

### 💵 费用管理 (Fees)
- 行 15, 86-90

### 👥 白名单 (Whitelist)
- 行 72-73, 92-96

### 📏 限额管理 (Limits)
- 行 45, 48, 54-55, 62, 66, 78-81, 97-98

### 🔐 权限控制 (Access Control)
- 行 42, 51, 59-61, 68, 84-85, 87, 89, 91, 94, 98, 101-103

---

## 🚨 按安全威胁类型分类

### 🛡️ 零值/边界攻击
```
行号: 11, 18, 43-44, 52-53, 74
关键测试: Deposit 10 Wei (通胀攻击防护)
```

### 🔮 预言机攻击
```
行号: 30-36
关键测试: Deposit Fails when prices outdated
```

### 👤 权限提升
```
行号: 42, 51, 59-61, 68, 84-85, 87, 89, 91, 94, 98, 101-103
关键测试: Non-Owner cannot pause vault
```

### 💣 DoS 攻击
```
行号: 38-39, 65, 70, 78-81
关键测试: Paused - max functions = 0
```

### 🌊 闪电贷攻击
```
行号: 19-23
关键测试: Deposit with 1% Flash Loan Fees
```

### 🏴‍☠️ 白名单绕过
```
行号: 72-73, 92-96
关键测试: Account not allowed
```

### 💰 债务超额
```
行号: 75
关键测试: debt > collateral
```

---

## 📊 按 ERC-4626 方法分组

| 方法 | 测试行号 | 数量 |
|------|---------|------|
| `deposit()` | 41-44, 46-47 | 6 |
| `mint()` | 48-53 | 6 |
| `withdraw()` | 54-61 | 8 |
| `redeem()` | 62-68 | 7 |
| `convert*()` | 25-29, 33-35 | 8 |
| `max*()` | 45, 48, 54-55, 62, 65-66 | 7 |
| `preview*()` | 46-47, 49, 56, 63 | 5 |
| `totalAssets()` | 36 | 1 |

---

## 🔧 实用命令

### 运行特定类别的测试

```bash
# 只运行安全测试（包含 Fail/Invalid/not allowed）
npx hardhat test test/core/vault/Vault.ts --grep "Fail|Invalid|not allowed|cannot|outdated"

# 只运行 ERC-4626 测试
npx hardhat test test/core/vault/Vault.ts --grep "Max|Preview|Deposit Success|Mint Success|Withdraw Success|Redeem"

# 只运行预言机相关测试
npx hardhat test test/core/vault/Vault.ts --grep "price|outdated|Price"

# 只运行权限测试
npx hardhat test test/core/vault/Vault.ts --grep "Owner|Role|Grant|Revoke|allowed"

# 只运行暂停功能测试
npx hardhat test test/core/vault/Vault.ts --grep "Pause|pause"

# 只运行费用相关测试
npx hardhat test test/core/vault/Vault.ts --grep "Fee|fee"
```

---

## 🎯 关键测试用例（必看）

### ⭐ Top 10 安全关键测试

1. **行 74**: `Deposit 10 Wei` - **防通胀攻击**（最重要）
2. **行 30-31**: `Deposit Fails - outdated prices` - **防预言机操纵**
3. **行 75**: `Deposit Fails - debt > collateral` - **防过度杠杆**
4. **行 18**: `Withdraw - minimum shares` - **防份额耗尽**
5. **行 84-85**: `Non-Owner cannot pause` - **防权限提升**
6. **行 72-73**: `Account not allowed` - **白名单强制**
7. **行 38-39**: `Fails when paused` - **紧急暂停有效**
8. **行 79-80**: `Deposit over max` - **防存款攻击**
9. **行 42, 51**: `No Allowance` - **防未授权操作**
10. **行 40**: `Transfer ETH should fail` - **防直接转账**

---

## 📝 注释

- **功能测试**: 正常业务流程
- **安全测试**: 边界条件、攻击防护、权限控制
- **ERC-4626**: 标准接口合规性
- **治理测试**: 参数配置、角色管理

**符号说明**:
- ✅ = 期望成功
- ❌ = 期望失败（安全保护）
- **加粗** = 安全关键测试

---

**最后更新**: 2025-10-13  
**总测试数**: 98  
**安全测试占比**: 35.7%

