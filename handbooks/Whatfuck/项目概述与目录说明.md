# 项目概述与目录说明（新手向）

本文件为初学者快速了解本仓库的结构、每个目录/关键文件的用途以及如何开始动手的指南。建议与《合约审计新手入门.md》《Solidity智能合约审计样板.md》《怎么弄.md》配合阅读。

## 一、项目简介（说人话）
- 本仓库是一个 DeFi 合约系统的工程与研究模板，包含金库（Vault）、多策略聚合（MultiStrategy）、批处理路由（VaultRouter）、预言机（Oracles）、可升级代理（Proxy）等模块。
- 同时配套了大量测试、Mock 合约与脚本，用于“安全验证/审计演练/可复现实验”。
- 面向新手：你可以像在护网演练中那样，通过“场景 → 触发 → 断言 → 报告”的方法，快速积累链上安全经验。

## 二、目录地图（从外到内）
- 根目录常见文件：
  - `README.md`：项目简要说明与使用指南入口。
  - `SECURITY.md`：安全与披露相关说明。
  - `Solidity智能合约审计样板.md`：审计流程模板（方法论、交付结构）。
  - `合约审计新手入门.md`：新手学习与实操路径。
  - `怎么弄.md`：工程化验证与实验操作手册（命令与流程）。
  - `package.json` / `package-lock.json`：依赖与脚本固定，建议用 `npm ci` 安装。
  - `hardhat.config.ts`：Hardhat 配置（编译、测试、覆盖率、Gas 报告等）。
  - `slither.config.json`：Slither 静态分析配置（可选）。
  - `echidna.yaml`：性质测试配置（可选）。
  - `tenderly.yaml`：Tenderly 调试/回放配置（可选）。
  - `tsconfig.json`：TypeScript 配置。
  - `audits/`：第三方审计报告（如 `audit-creed-2024-05-10.pdf`）。

- 代码与文档主体：
  - `contracts/`：Solidity 合约源代码（核心、接口、库、预言机、代理、Mocks、Solidity层测试）。
  - `test/`：TypeScript 测试（集成/PoC/场景验证）。
  - `scripts/`：部署与运维脚本（Hardhat 任务、网络配置、升级与验证）。
  - `doc/`：模块级文档与架构图（深入理解各合约与接口）。
  - `src/types/`：TypeChain 生成的类型定义（供 TS 测试与脚本使用）。
  - `constants/`：合约选择器、网络部署配置、测试账户等常量。

## 三、深入目录与关键文件用途
- `contracts/core/`
  - `Vault.sol` / `VaultBase.sol`：金库核心逻辑与基础能力（存款、赎回、计价）。
  - `MultiStrategy.sol`：多策略聚合与分配（组合与风险管理）。
  - `VaultRouter.sol`：批处理与命令调度（路由调用入口）。
  - `VaultRegistry.sol` / `VaultSettings.sol`：金库注册与参数/治理设置。
  - `GovernableOwnable.sol`：权限/治理相关基类。
  - 子目录 `flashloan/`、`governance/`、`hooks/`、`router/`、`strategies/`：对应专项功能与扩展。

- `contracts/interfaces/`
  - 第三方协议接口与自定义接口集合（如 `aave/`、`uniswap/`、`chainlink/` 等）。审计时用来梳理外部依赖与调用面。

- `contracts/libraries/`
  - 可复用的数学/换算工具（如 `MathLibrary.sol`、`RebaseLibrary.sol`、`UniV2Library.sol`）。关注精度、舍入、边界与溢出。

- `contracts/mocks/`
  - 攻击/误用/外部协议的简化模拟（如 `BorrowerAttacker.sol`、`VaultRouterMock.sol`、`OracleMock.sol`）。用于 PoC 与测试复现。

- `contracts/oracles/`
  - 预言机实现（`ChainLinkOracle.sol`、`PythOracle.sol` 等）。审计关注数据新鲜度、偏差限幅、回退策略与操纵门槛。

- `contracts/proxy/`
  - 代理与管理员（如 `BakerFiProxy.sol`）。重点检查 `delegatecall` 使用、存储布局、升级兼容与治理流程。

- `contracts/tests/`
  - Solidity 层面的测试样例（如 `BoringRebaseTest.sol`、`LeverageTest.sol`）。与 TS 测试互补。

- `test/`
  - `core/`、`oracles/`、`proxy/`、`hooks/`、`libraries/` 等分类测试。示例：
    - `core/BalancerFlashLoan.ts`：闪电贷 PoC/交互测试。
    - `oracles/*`：价格与风控相关测试。
    - `proxy/*`：升级与存储兼容性测试。
  - 可直接运行并生成覆盖率/Gas 报告，作为审计的工程化证据。

- `scripts/`
  - `deploy-dev.ts`、`deploy-router.ts`、`deploy-multistrategy-dev.ts`：本地或测试网部署脚本。
  - `tasks/*`：Hardhat 自定义任务（如部署、设置、策略、路由、预言机）。
  - `upgrade-*.ts`：升级演练与验证脚本。
  - `verify.ts`：合约校验脚本。

- `doc/`
  - 按模块细分的说明文档与架构图（`architecture.png`）。新手可以从这里理解系统组成与调用关系。

- `src/types/`
  - TypeChain 输出，供 TypeScript 调用合约接口时获得类型安全与自动生成的工厂类。

- `constants/`
  - `selectors.json` / `contract-selectors.json`：方法选择器映射；
  - `network-deploy-config.ts`：网络相关部署参数；
  - `test-accounts.ts`：测试账户配置；
  - 其它常量类型与工具。

## 四、如何开始（最小可跑）
- 安装依赖：`npm ci`
- 运行测试：`npx hardhat test`
- 生成覆盖率：`npx hardhat coverage`
- Gas 报告：`REPORT_GAS=true npx hardhat test`
- 本地部署：`npx hardhat --network localhost run scripts/deploy-dev.ts`

实操路线建议：
- 第一步：跑测试并看日志，定位你感兴趣的场景（比如闪电贷或预言机）。
- 第二步：打开对应的 `contracts/mocks/*` 与 `test/*`，找到触发参数与断言。
- 第三步：尝试写一个“负测试/断言”或小 PoC，验证你的理解。
- 第四步：将结果归档（覆盖率/Gas/命令/日志），形成你的“审计证据链”。

## 五、面向新手的注意事项
- 权限与初始化永远排第一：检查 `owner/admin/governance` 是否正确、初始化是否安全。
- 外部调用要警觉重入：遵循 `checks-effects-interactions`，必要时引入防护。
- 升级要看存储：升级后的变量布局必须兼容，事件与选择器需一致。
- 价格要有风控：新鲜度、偏差上限、回退与多源聚合，避免被操纵。
- 经济与 DoS 不忽视：关注关键路径 Gas 与失败路径成本，设置规模/额度限制。

## 六、结论与下一步
- 这个仓库既是“系统实现”，也是“审计与验证演练场”。
- 你可以从一两个模块入手（如 Vault 或 Oracles），先跑通测试，再尝试 PoC 与断言，逐步建立链上安全的完整心智模型。
- 推荐配套阅读：《合约审计新手入门.md》《Solidity智能合约审计样板.md》《怎么弄.md》，并按其中的流程生成覆盖/Gas/静态分析报告，形成可复现的审计证据链。

如需，我可以为你生成“一键最小复现脚本”与“审计报告模板”，帮助你从零到第一份审计交付。