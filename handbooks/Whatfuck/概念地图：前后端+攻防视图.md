# 概念地图：前后端 + 攻防（ATT&CK）视图

本文档提供一页式概念地图，帮助你以“功能/架构”为主轴，同时叠加“攻防（ATT&CK）”覆盖视图，并用“前后端”标注触达路径。用于快速建立审计框架与落地检查清单。

## 1. 模块视图（功能主轴）
- `Vault`/`VaultBase`/`MultiStrategyVault`：金库产品与资产份额，策略组合与再平衡。
  - 参考：`contracts/core/Vault.sol`、`contracts/core/VaultBase.sol`、`doc/core/Vault.md`、`doc/core/MultiStrategyVault.md`
- `VaultRouter`/`MultiCommand`：统一入口与批处理命令，参数映射与状态机一致性。
  - 参考：`contracts/core/VaultRouter.sol`、`contracts/core/MultiCommand.sol`、`doc/core/VaultRouter.md`、`doc/core/MultiCommand.md`
- `Strategies`：策略接口与具体协议集成（Aave/Curve/Uni 等）。
  - 参考：`contracts/core/strategies/`、`doc/core/strategies/`、`doc/interfaces/*`
- `Oracles`：价格/比率获取与新鲜度控制（Pyth/ChainLink/Ratio/ExRate）。
  - 参考：`contracts/oracles/*`、`doc/oracles/*`
- `VaultSettings`：参数面板（费用、限额、阈值、白名单等）。
  - 参考：`contracts/core/VaultSettings.sol`、`doc/core/VaultSettings.md`
- `Registry`：`VaultRegistry` 地址解析与产品目录。
  - 参考：`contracts/core/VaultRegistry.sol`、`doc/core/VaultRegistry.md`
- `Proxy`：`TransparentUpgradeableProxy` 等价模型（本仓库 `BakerFiProxy`），`ProxyAdmin` 管理升级。
  - 参考：`contracts/proxy/BakerFiProxy.sol`、`doc/proxy/BakerFiProxy.md`、`doc/proxy/BakerFiProxyAdmin.md`、`doc/storage-compatibility.md`
- `Libraries`：数学、DEX 辅助库。
  - 参考：`contracts/libraries/*`、`doc/libraries/*`

## 2. 数据视图（资产/费用/余额流）
- 资产-份额：ERC-4626 等价模型（存入/取出、铸造/销毁、`totalAssets/totalSupply`）。
- 费用路径：管理费、绩效费、入场/退出费的扣取与归集账户。
- 余额流向：用户 → 路由 → 金库 → 策略（与外部协议）→ 金库 → 用户。
- 事件证据：`Deposit/Withdraw/Rebalance/Harvest` 等事件与回执。

## 3. 执行视图（入口/参数/状态机）
- 入口端点：`VaultRouter` + `Commands/MultiCommand`、金库的 `external/public` 函数。
- 参数映射：批处理数组、复合结构的边界与语义约束；防错与默认值。
- 状态机一致性：原子性、回滚、部分成功残留的清扫；资金流入/出一致性。
- 外部依赖：预言机新鲜度/偏差、DEX 滑点、借贷清算；失败路径与保护语义。

## 4. 权限与治理视图（角色矩阵）
- 角色/修饰器：`Ownable/Governable/AccessControl/Whitelist/Pausable`。
- 高权限入口：升级、参数面板（`VaultSettings`）、策略管理、路由命令白名单。
- 审批与证据链：事件、时间锁（如果有）、多签（如果有），与脚本操作对应关系。

## 5. 升级与存储视图（持久化）
- 代理升级：`BakerFiProxy` 与 `ProxyAdmin` 的职责分离；初始化与版本迭代流程。
- 存储兼容：槽位布局、扩展位置、继承顺序；`EmptySlot.sol` 用途。
- 回滚策略：升级失败/热修影响与应急（暂停、参数限额）。

## 6. 运维视图（前后端触达路径）
- 前端/脚本入口：`scripts/tasks/*.ts`、`scripts/deploy-*.ts`、`scripts/upgrade-*.ts`。
- 触达路径：TypeScript → Hardhat → ABI → 合约函数 → 事件/回执。
- 重要脚本：
  - 部署：`scripts/deploy.ts`、`scripts/deploy-router.ts`、`scripts/deploy-multistrategy-dev.ts`
  - 参数：`scripts/tasks/settings.ts`、`scripts/tasks/router.ts`、`scripts/tasks/oracles.ts`
  - 升级：`scripts/upgrade-*.ts`、`doc/proxy/BakerFiProxyAdmin.md`

---

## 7. 攻防（ATT&CK）覆盖视图

以下用 Web 渗透为主类比视角（约 70%），主机持久化为补充视角（约 30%）：

- 入口与信任边界（Web）
  - 枚举端点：`VaultRouter` + 命令集、金库 `external` 函数。
  - 授权修饰器：白名单/角色/暂停/限额；`permit/allowance` 等价物。
  - 重放与序列：`nonce`/版本字段（如果存在），事件对齐与顺序约束。
- 参数语义与注入（Web）
  - 批处理链入参：数组越界、默认值陷阱、命令组合冲突。
  - 外部返回值：AMM 报价、预言机数据的可信性检查；失败路径与回滚。
- 状态机与事务一致性（Web）
  - 原子性与回滚一致性；部分成功残留资产的清扫策略。
  - 资金流对账：入/出事件与余额一致性，费用扣取路径。
- 外部集成风险（Web）
  - 预言机新鲜度与偏差阈值；多源比对（Pyth/ChainLink）。
  - DEX 滑点与报价偏移；借贷健康因子与清算安全窗。
- 高权限与特权路径（主机）
  - 升级、参数面板、策略更换等入口的角色矩阵与审批语义。
  - 脚本到合约的映射：谁、何时、以何参数执行（`scripts/tasks/*`）。
- 升级与存储持久化（主机）
  - 代理升级与初始化：版本迁移步骤与事件证据；失败回滚预案。
  - 存储槽位兼容：新增变量、继承顺序、`EmptySlot` 预留；与 `doc/storage-compatibility.md` 对照。

---

## 8. 快速检查清单（可直接用于审计启动）

- 端点枚举与授权核对
  - 列出 `VaultRouter` 及金库所有对外函数；标注修饰器与角色。
  - 对照 `scripts/tasks/*` 确认运维入口与参数集。
- 参数语义与边界
  - 批处理命令数组的类型与语义约束；默认值与禁止组合。
  - 外部返回值检查与失败处理；滑点与新鲜度参数的位置。
- 状态机一致性与对账
  - 事件-余额-资金流的三表对齐（入/出/费用）。
  - 回滚/部分成功的残余资产与中间态清扫。
- 高权限与升级
  - 升级、参数变更、策略管理的角色矩阵与审批证据。
  - 存储兼容与版本迁移步骤；`EmptySlot` 与新变量位置。

---

## 9. 交叉链接（便于深入）

- 核心合约与文档
  - `contracts/core/Vault.sol` ↔ `doc/core/Vault.md`
  - `contracts/core/VaultRouter.sol` ↔ `doc/core/VaultRouter.md`
  - `contracts/core/MultiCommand.sol` ↔ `doc/core/MultiCommand.md`
  - `contracts/core/VaultSettings.sol` ↔ `doc/core/VaultSettings.md`
  - `contracts/core/VaultRegistry.sol` ↔ `doc/core/VaultRegistry.md`
  - `contracts/proxy/BakerFiProxy.sol` ↔ `doc/proxy/BakerFiProxy.md` / `doc/proxy/BakerFiProxyAdmin.md`
  - `contracts/oracles/*` ↔ `doc/oracles/*`
- 运维脚本
  - 部署：`scripts/deploy.ts`、`scripts/deploy-router.ts`、`scripts/deploy-multistrategy-dev.ts`
  - 参数：`scripts/tasks/settings.ts`、`scripts/tasks/router.ts`、`scripts/tasks/oracles.ts`
  - 升级：`scripts/upgrade-*.ts`、`scripts/verify.ts`

---

## 10. 使用方式

- 审计前阅读顺序：模块视图 → 执行视图 → 权限/升级视图 → 攻防覆盖视图。
- 辅助操作：按“快速检查清单”逐项做笔记与 PoC；把事件/回执打成证据链。
- 可选：结合 `test/*` 用最小用例验证入参/事件/余额变更（例如 `test/proxy/VaultProxy.ts`）。

如需，我可进一步生成“最小实验步骤卡”（路由批处理、策略收割与再平衡、代理升级）并配合截图/预期输出。