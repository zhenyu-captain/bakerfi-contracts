# 项目术语与概念词典（专业解释 + 白话解释）

本词典面向新入门的合约审计与攻防人员，依据当前仓库代码与文档抽取常见概念词，提供“专业解释”和“白话解释”，并尽量标注相关文件以便快速定位。

- 适用范围：BakerFi 项目当前版本与目录结构（`contracts/`、`doc/`、`scripts/`、`test/`、`src/types/`）。
- 目标读者：从传统攻防演训/护网转向链上合约审计的同学。

## 核心架构与金库
- 术语：Vault（金库）
  - 专业解释：遵循 `ERC-4626` 标准的资产金库合约，管理存款、赎回、份额与资产转换等核心逻辑；在本项目中由 `Vault.sol`/`VaultBase.sol` 实现，并支持升级与治理参数配置。
  - 白话解释：像“银行账户”和“基金份额”的结合，负责收钱、发钱、算份额，规则清晰，可插拔升级。
  - 相关文件：`contracts/core/Vault.sol`、`contracts/core/VaultBase.sol`、`src/types/contracts/core/Vault.ts`

- 术语：MultiStrategyVault（多策略金库）
  - 专业解释：继承 `VaultBase` 和 `MultiStrategy` 的组合金库，支持多策略权重分配、收益收割（Harvest）、再平衡（Rebalance）等高级操作，并通过命令形式执行策略级别动作；支持白名单（AccountWhitelist）与费用配置。
  - 白话解释：能把钱分给多个策略去“打工”，再按权重调整、收割收益，且能限制谁能进出金库。
  - 相关文件：`contracts/core/MultiStrategyVault.sol`、`src/types/contracts/core/MultiStrategyVault.ts`

- 术语：VaultSettings（金库设置）
  - 专业解释：金库的参数管理组件，包含费用、上限、权限等配置；在初始化与升级过程中作为依赖注入。
  - 白话解释：金库的“设定面板”，调费率、开关、限制等。
  - 相关文件：`contracts/core/VaultSettings.sol`、`src/types/hardhat.d.ts`（部署/类型）

- 术语：VaultRegistry（金库/服务注册表）
  - 专业解释：维护一组服务地址（如 `FLASH_LENDER_CONTRACT`、`AAVE_V3_CONTRACT`、`VAULT_ROUTER_CONTRACT` 等），支持按名称解析依赖，便于模块解耦与统一管理。
  - 白话解释：系统“通讯录”，记录各模块入口地址，其他合约通过名字来找它们。
  - 相关文件：`contracts/core/VaultRegistry.sol`、`doc/core/VaultRegistry.md`

- 术语：MultiStrategy（多策略组合）
  - 专业解释：在同一金库中管理多个策略的分配与权重，提供再平衡接口；与 `MultiStrategyVault` 结合，形成可灵活管理的收益组合。
  - 白话解释：把钱分到不同“赚钱方法”，按比例调整，让整体更稳或更优。
  - 相关文件：`contracts/core/MultiStrategy.sol`、`contracts/core/MultiStrategyVault.sol`

## 路由与批处理命令
- 术语：VaultRouter（金库路由）
  - 专业解释：受 Uniswap V3 Router 启发的批处理路由器，支持 `ERC4626` 金库操作、WETH 包装/拆包、代币转移、DEX 交换等，并能用 `execute` 执行多条命令（multicall）。
  - 白话解释：一次把多步操作串起来干，比如先换币再存金库，像脚本一样连着执行。
  - 相关文件：`contracts/core/VaultRouter.sol`、`doc/core/VaultRouter.md`、`src/types/contracts/core/VaultRouter.ts`

- 术语：MultiCommand（多命令批处理）
  - 专业解释：定义命令序列的抽象组件，支持在一个交易中按顺序执行多条命令；提供 `dispatch` 与 `execute`，失败即整体回滚；使用保留的 `callStack` 8 槽传递中间输入/输出。
  - 白话解释：把多步指令打包成“一次性执行”，中途有输出就可以喂到下一步，出错整单取消。
  - 相关文件：`contracts/core/MultiCommand.sol`

- 术语：Commands（命令集与参数映射）
  - 专业解释：路由命令的枚举与工具集；`action` 的低 32 位表示动作类型，32–63 位表示输入映射，64–95 位表示输出映射，用于串联命令间的参数位置与回传值；支持如 `PUSH_TOKEN`、`WRAP_ETH`、`ERC4626_VAULT_DEPOSIT` 等。
  - 白话解释：把每个“指令”编码成数字，指定要执行什么、怎么把前一步的结果塞进下一步的参数。
  - 相关文件：`contracts/core/router/Commands.sol`（类型与常量），`VaultRouter.sol` 中的 `dispatch/_handle*`

- 术语：Input/Output Mapping（输入/输出映射）
  - 专业解释：在批处理执行时，使用 `action` 的特定位段描述把 `callStack` 中的某槽内容注入到当前命令的第 N 个参数或输出位置，实现命令间数据流动。
  - 白话解释：告诉系统“上一条的结果放到这条第几个参数里”。
  - 相关文件：`VaultRouter.sol`（`pullInputParam` 等逻辑）

## 策略与外部协议
- 术语：Strategy（策略）
  - 专业解释：具体收益或操作逻辑的实现单元，如杠杆策略、换币策略等；由金库调用并管理权重，支持收割/再平衡。
  - 白话解释：赚钱/操作“插件”，金库按比例把钱分配给它们干活。
  - 相关文件：`contracts/core/strategies/*`、`src/types/index.ts`（各策略类型工厂）

- 术语：AAVE v3 / Morpho Blue（外部借贷协议）
  - 专业解释：集成的主流借贷协议，用于杠杆与收益；通过接口类型与 mocks/tests 进行联调与 PoC 验证。
  - 白话解释：外部平台，用来借币、加杠杆，提升收益或构建复杂操作。
  - 相关文件：`contracts/interfaces/aave/*`、`contracts/interfaces/*/morpho*`、`test/core/strategies/*`

- 术语：Uniswap V3 / Aerodrome / Curve / Balancer（AMM/DEX/流动性组件）
  - 专业解释：路由器可调用的交换与流动性模块，提供精确输入/输出交换、报价器、不同链上 DEX 的适配库。
  - 白话解释：换币、流动性的“交易所与工具箱”。
  - 相关文件：`contracts/interfaces/uniswap/*`、`contracts/libraries/*`、`src/types/hardhat.d.ts`（接口与库部署）

## 预言机与价格
- 术语：Oracle（预言机）
  - 专业解释：从链外或其他来源获取价格/比率数据的合约，支持新鲜度（时间戳）、偏差（阈值）与回退机制的校验；本项目包含 `PythOracle`、`ChainLinkOracle`、`ExRateOracle`、`RatioOracle`。
  - 白话解释：给系统“报价格”的模块，要考虑是否新鲜、是否离谱、坏了怎么兜底。
  - 相关文件：`contracts/oracles/*`、`doc/oracles/*`、`test/oracles/*`、`test/pyth/*`

## 权限、治理与安全控制
- 术语：OwnableUpgradeable（所有权）
  - 专业解释：OpenZeppelin 升级版所有权模块，定义 `owner`，常用于部署与管理权限；本项目在多处继承使用。
  - 白话解释：“谁是老板”，一些敏感操作只有老板能做。
  - 相关文件：`contracts/core/GovernableOwnable.sol`（内部使用 OZ 模块）、`src/types/*/Ownable.ts`

- 术语：GovernableOwnable（所有者 + 治理者）
  - 专业解释：扩展所有权，单独引入 `governor` 角色，提供 `onlyGovernor` 修饰符与治理权转移；适合只需两角色的合约。
  - 白话解释：除了老板，还有“治理者”，两套权限，方便分工。
  - 相关文件：`contracts/core/GovernableOwnable.sol`

- 术语：AccessControl / Roles（访问控制/角色）
  - 专业解释：基于角色的权限管理（如 `DEFAULT_ADMIN_ROLE`），限制函数调用；在金库与路由等模块用于敏感操作。
  - 白话解释：给不同人发“门卡”，看卡片能不能开这道门。
  - 相关文件：`src/types/contracts/core/Vault.ts`、`MultiStrategyVault.ts`（含角色/事件）

- 术语：Whitelist（白名单）
  - 专业解释：限制可交互地址集合，常用于 Beta 阶段或受控试运行，相关事件如 `AccountWhiteList(address,bool)`。
  - 白话解释：只有名单里的地址能用，防止乱入。
  - 相关文件：`contracts/core/MultiStrategyVault.sol`、`src/types/contracts/core/MultiStrategyVault.ts`

- 术语：Pausable（可暂停）
  - 专业解释：在出现异常时可暂停某些敏感操作；项目在 `VaultBase` 注释中说明由 `pauser` 角色控制。
  - 白话解释：出现危险时“急停按钮”，临时停用关键功能。
  - 相关文件：`contracts/core/MultiStrategyVault.sol` 注释说明、`VaultBase`（实现参考）

## 代理、升级与存储兼容
- 术语：TransparentUpgradeableProxy（透明可升级代理）
  - 专业解释：OZ 提供的代理模式，用户与代理交互，代理指向实现合约；管理员可升级实现但不干扰普通用户调用。
  - 白话解释：门面地址不变，内部“换发动机”，用户无感，管理员能换版本。
  - 相关文件：`contracts/proxy/BakerFiProxy.sol`、`doc/proxy/BakerFiProxy.md`、`src/types/index.ts`

- 术语：ProxyAdmin / BakerFiProxyAdmin（代理管理员）
  - 专业解释：具有升级权限的管理员合约，支持 `upgrade`、`upgradeAndCall`、`changeProxyAdmin` 等；需严格管控所有权与操作审计。
  - 白话解释：能“替换实现”的权力入口，必须管住钥匙。
  - 相关文件：`src/types/@openzeppelin/.../ProxyAdmin.ts`、`src/types/contracts/proxy/BakerFiProxyAdmin.ts`、`doc/proxy/BakerFiProxyAdmin.md`

- 术语：Upgrade / UpgradeAndCall（升级与升级回调）
  - 专业解释：将代理指向新的实现合约，可带初始化数据进行迁移；需关注事件、版本化与存储布局兼容。
  - 白话解释：上新版同时跑一段初始化，注意别把“变量位置”搞乱。
  - 相关文件：`BakerFiProxyAdmin.ts`、`ProxyAdmin.ts`、`scripts/upgrade-*.ts`

- 术语：Storage Layout Compatibility（存储布局兼容）
  - 专业解释：升级后合约的存储槽位置需与旧版本兼容，否则会破坏状态；需通过 `storage-compatibility.md` 或升级脚本与检查工具确认。
  - 白话解释：换版本不能把“抽屉顺序”弄乱，否则数据串了。
  - 相关文件：`doc/storage-compatibility.md`、`scripts/upgrade-*.ts`

## 费用、限额与再平衡
- 术语：FeeReceiver（费用接收者）
  - 专业解释：金库产生的费用接受地址，可由治理设定；与 `PerformanceFee`、`WithdrawalFee` 等配合。
  - 白话解释：手续费给谁，能改、要记。
  - 相关文件：`src/types/contracts/core/Vault.ts`、`MultiStrategyVault.ts`

- 术语：PerformanceFee / WithdrawalFee（业绩费/取款费）
  - 专业解释：根据收益或赎回动作收取的费用，影响用户净收益；需在策略与金库层面正确计提与结算。
  - 白话解释：赚钱或取钱时要扣的费，规则要说清楚。
  - 相关文件：`src/types/contracts/core/Vault.ts`、`MultiStrategyVault.ts`

- 术语：Harvest（收割）
  - 专业解释：将策略产生的收益归集到金库或进行复投，通常作为再平衡的一部分；本项目在 `MultiStrategyVault` 中定义命令常量 `HARVEST_VAULT`。
  - 白话解释：把赚到的钱收回来或继续投，让收益落袋或滚动。
  - 相关文件：`contracts/core/MultiStrategyVault.sol`

- 术语：Rebalance（再平衡）
  - 专业解释：调整各策略权重或头寸，使组合回到目标配置；`REBALANCE_STRATEGIES`、`CHANGE_WEIGHTS` 为相关命令常量。
  - 白话解释：把钱的分配比例重新调一调，保持稳健或符合策略。
  - 相关文件：`contracts/core/MultiStrategyVault.sol`

- 术语：MaxDeposit / MaxMint / ConvertToAssets/Shares（限额与换算）
  - 专业解释：`ERC-4626` 定义的上限与转换接口，控制单用户或整体的最大存款/铸造份额，并提供资产与份额之间的精确换算。
  - 白话解释：最多能存多少、发多少份额，以及份额和钱怎么互相换算。
  - 相关文件：`src/types/contracts/core/Vault.ts`

## 代币与标准
- 术语：ERC-4626（金库代币标准）
  - 专业解释：规范存款、赎回、份额与资产的交互行为，使金库可被聚合器与钱包标准集成。
  - 白话解释：让各家金库“说同一种话”，方便别人接入。
  - 相关文件：`VaultRouter.sol` 引用、`contracts/interfaces/*`、`src/types/contracts/core/Vault.ts`

- 术语：WETH（包装以太）
  - 专业解释：将原生 ETH 包装为 ERC-20 代币，以便在标准化代币接口下交互；路由支持 `WRAP_ETH` / `UNWRAP_ETH`。
  - 白话解释：把 ETH 装进“标准代币外壳”，方便跟别的代币一起用。
  - 相关文件：`contracts/interfaces/tokens/IWETH.sol`、`VaultRouter.sol`

- 术语：Permit / IERC20Permit（授权签名）
  - 专业解释：通过离线签名授权某地址转移代币，避免链上先 `approve` 再操作，减少交互成本；路由与 hooks 支持签名授权流程。
  - 白话解释：用签名“远程开门”，省一次上链的授权步骤。
  - 相关文件：`VaultRouter.sol`、`contracts/core/hooks/*`、`src/types/*/IERC20Permit.ts`

- 术语：Sweep Tokens / Sweep Native（清扫多余余额）
  - 专业解释：将合约或中间余额归集到指定地址，避免残留资产；在路由中作为命令存在。
  - 白话解释：把操作后剩下的零钱扫走，归拢到一起。
  - 相关文件：`VaultRouter.sol`

## 注册与常量
- 术语：Service Registry Keys（服务键）
  - 专业解释：在 `VaultRegistry` 中用 `bytes32` 常量标识外部服务（如 `FLASH_LENDER_CONTRACT`、`AAVE_V3_CONTRACT`、`VAULT_ROUTER_CONTRACT`），通过键获取地址。
  - 白话解释：用“名字标签”找对应的模块地址。
  - 相关文件：`doc/core/VaultRegistry.md`、`contracts/core/VaultRegistry.sol`

- 术语：Network Deploy Config / Selectors（网络配置与选择器）
  - 专业解释：各链上部署地址、接口选择器与常量在 `constants/` 维护，脚本与测试据此选择目标地址与行为。
  - 白话解释：把多条链的地址与配置集中记录，脚本查表使用。
  - 相关文件：`constants/*`、`mappings.json`

## 错误与事件（示例）
- 术语：InvalidCommand（无效命令）
  - 专业解释：当路由/批处理遇到未定义或不允许的 `action` 时抛出，防止错误执行。
  - 白话解释：指令写错了，系统拒绝执行并报错。
  - 相关文件：`contracts/core/MultiCommand.sol`

- 术语：NotAuthorized（未授权）
  - 专业解释：路由的敏感操作未通过权限校验时抛出，避免越权操作。
  - 白话解释：没权限做这事，被系统挡住了。
  - 相关文件：`contracts/core/VaultRouter.sol`

- 术语：ServiceUnknown / ServiceAlreadySet（服务未知/重复设置）
  - 专业解释：在注册表操作中，当查询未知服务或重复设置已存在的服务时抛出。
  - 白话解释：通讯录里查不到这个人，或已经有了还想再加一次。
  - 相关文件：`doc/core/VaultRegistry.md`

- 术语：CallerNotTheGovernor（非治理者）
  - 专业解释：当需要治理者权限的操作由非治理者发起时抛出。
  - 白话解释：这事只有治理者能做，其他人做会报错。
  - 相关文件：`contracts/core/GovernableOwnable.sol`

## 运维、部署与脚本
- 术语：Hardhat Tasks（任务脚本）
  - 专业解释：封装部署、参数修改、路由配置、策略管理等操作的脚本入口，位于 `scripts/tasks/*`，支持多网络；与 `constants/` 联动。
  - 白话解释：命令行“工具箱”，一条指令完成部署或修改配置。
  - 相关文件：`scripts/tasks/*.ts`

- 术语：Upgrade Scripts（升级脚本）
  - 专业解释：针对不同版本的升级流程，包含实现替换、初始化数据与校验输出；需审计与记录证据链。
  - 白话解释：上新版本的“流程清单”，一步步把代理指向新实现。
  - 相关文件：`scripts/upgrade-*.ts`

- 术语：TypeChain（类型生成）
  - 专业解释：将 Solidity ABI 生成 TypeScript 类型与工厂，方便 TS 层安全调用与自动补全。
  - 白话解释：自动生成“类型字典”，写 TS 脚本更不容易出错。
  - 相关文件：`src/types/*`

## 测试与验证
- 术语：Integration Tests / PoC（集成测试/概念验证）
  - 专业解释：在 `test/` 目录编写的 TypeScript 场景测试，覆盖路由、钩子、预言机、代理与策略的关键路径；用于复现实验与安全回归。
  - 白话解释：用脚本把关键用法跑一遍，验证有没有坑，把漏洞复现出来。
  - 相关文件：`test/**/*`

- 术语：Slither（静态分析）
  - 专业解释：Solidity 静态分析工具，检测常见模式与风险；通过 `slither.config.json` 配置。
  - 白话解释：自动扫代码找常见问题的工具。
  - 相关文件：`slither.config.json`

- 术语：Echidna（性质测试）
  - 专业解释：基于随机化与性质（不变量）验证的测试框架，检查合约在大量输入下是否违反约束。
  - 白话解释：用“随机压力测试”看合约会不会在某些情况下出错。
  - 相关文件：`echidna.yaml`

- 术语：Coverage / Gas Report（覆盖率/气体报告）
  - 专业解释：测试覆盖率衡量代码被测试的比例；Gas 报告评估交易执行的成本与优化空间。
  - 白话解释：测到了多少代码、跑一次要花多少 gas。
  - 相关文件：`package.json` 脚本、测试输出目录

## 快速使用建议
- 查找概念的所在代码：优先看 `contracts/*` 与 `doc/*`，配合 `src/types/*` 了解可调用接口与事件。
- 结合测试与脚本：在 `test/*` 复现关键场景，在 `scripts/tasks/*` 验证治理/升级与路由配置。
- 证据链：收集事件、余额变化、回滚原因、版本与存储布局比对，放入审计报告或演练记录。

## 更新与补充
- 本词典依据当前仓库快照编制，后续新增模块或改动请在 `handbooks/术语与概念词典.md` 中补充。
- 建议在合并新策略/路由命令/升级脚本时同步更新相关术语条目。

## 用一个生活化故事理解本项目（理财与运营版）

设想一家互联网理财平台“烘焙财富”（BakerFi）。产品经理想做一款“多策略理财金库”，把用户的钱分配到不同的理财方式里，既能随时存取，又能灵活升级迭代。下面是一条从产品到运营的真实世界故事，串联起项目里的关键模块。

第一章：开张与挂牌（地址通讯录与金库门面）
- 平台需要把各个内部服务登记到一份“通讯录”，这样任何模块要找另一个模块，只要报名字就行。这就是 `VaultRegistry`，相当于企业的总机与分机表。
- 为了让产品可以迭代升级但用户的入口不变，平台把“门面地址”固定下来，内部实现可以替换。这就是 `TransparentUpgradeableProxy` 的用法；管理员钥匙在 `ProxyAdmin/BakerFiProxyAdmin` 手里，类似“运维有权替换后端服务，但不会影响用户访问的网址”。

第二章：用户来存钱（一次办理多项业务的柜台）
- 用户把资金打到平台，有时带着原生币（像现金），需要先换成统一记账的代币（像存成银行卡上的余额）。这里用到 `WETH` 的“包装”，而平台用 `VaultRouter` 当“综合柜台”：可以把“换钱”“转账”“存款”一次串起来办。
- 柜台内部把一连串动作写成“办理单”，这就是 `Commands` / `MultiCommand`。比如：先换钱，再把余额推到缓冲区，再执行 `ERC4626` 的“存金库”。中间每一步的结果自动填到下一步的表格里，这叫 `Input/Output Mapping`（像把上一张单子的金额自动抄到下一张单据的金额栏）。办完后，把零散余额集中到指定账户，相当于财务把零钱统一清点，这叫 `SWEEP_TOKENS`。
- 如果用户事先签过一个“授权书”（`Permit/IERC20Permit`），柜台一次就能把授权和后续业务都办了，减少来回折腾。

第三章：钱去哪里（多策略理财组合）
- 平台把用户的资金分配到多种理财“策略”里：有的策略偏稳（像存入大平台的借贷池 AAVE/Morpho），有的策略偏流动（像在不同交易所做兑换与流动性管理 Uniswap/Aerodrome/Curve/Balancer）。统筹这个组合的就是 `MultiStrategyVault`，它像一位组合经理，按权重把钱派出去。
- 为了知道资产的参考价格，平台会接入“报价服务”（`PythOracle`、`ChainLinkOracle` 等），确保报价够新、偏差在合理范围；这类似理财经理看权威行情源，避免用过期或异常报价。
- 一段时间后，平台会“收割收益”（`Harvest`）并考虑复投；也会“再平衡”（`Rebalance`），把各策略的权重拉回目标比例。平台设置的费用（`PerformanceFee`、`WithdrawalFee`）会自动计提并打到指定账户（`FeeReceiver`），就像基金公司的管理费与赎回费。
- 金库遵循 `ERC-4626` 标准，清晰地定义了“最多能存多少”（`maxDeposit`/`maxMint`）与“份额和资产的换算”（`convertToAssets/Shares`），方便与钱包、聚合器接入。

第四章：运营同事的日常（参数面板与批量操作）
- 运营需要调整产品参数，比如提高单笔上限或修改组合权重，都会在 `VaultSettings` 面板上完成；对应的批量操作命令像“运营脚本”，把复杂事项一次执行到位（如 `CHANGE_WEIGHTS`、`REBALANCE_STRATEGIES`）。
- 团队把常用操作封装成命令行工具（`scripts/tasks/*`），就像运营后台的按钮：部署、改参数、注册服务、路由配置，都有现成入口。偶尔会遇到“通讯录里还没登记就去调用”（`ServiceUnknown`）或“重复登记”（`ServiceAlreadySet`）这类日常错误，提示把流程补齐。

第五章：产品升级与兼容（门面不变，内部迭代）
- 当产品要升级，管理员用 `upgrade/upgradeAndCall` 替换后端实现并做初始化，就像夜间维护窗口上线新版本。
- 升级最大的讲究是“存储布局兼容”（`storage-compatibility.md`）：抽屉的顺序不能乱，老数据要在新版本里还能正确读写。这是保证用户余额与份额不出错的关键。
- 升级后，平台会重新生成类型定义（`TypeChain`），前端和脚本的“自动补全与类型检查”更新到新接口；再跑一遍用例与报告（覆盖率与 gas），确保性能和费用都在预期。

第六章：把故事串成一套操作手册（给新同事）
- 如果你是新同事：
  1) 先看 `VaultRegistry` 明确模块地址；
  2) 通过代理部署金库（门面地址固定）；
  3) 用 `VaultRouter` 把“换币→转账→存金库”一次办完；
  4) 选择 `MultiStrategyVault` 管理组合，配置报价源与费用；
  5) 在 `VaultSettings` 调整上限与权重，定期 `Harvest/Rebalance`；
  6) 需要升级时，遵守存储兼容，更新类型并复测。
- 这整套流程和词典里的概念一一对应：
  `Vault` 是资金容器；`MultiStrategyVault` 是组合引擎；
  `VaultRouter` 是综合柜台；`Registry` 是通讯录；
  `ProxyAdmin` 是升级钥匙；`Oracles` 是报价服务；
  `VaultSettings` 是运营面板；`Commands/MultiCommand` 是办理单；
  `ERC-4626` 是行业标准；脚本与测试是“运营 SOP”。

这个生活化版本不涉及攻防演练，它更像一条互联网理财产品从“开户、办业务、理财、调参数、升级”的完整流水线，帮助你在现实场景里理解每个模块的职责与协作方式。