# 链上合约渗透测试作战手册（BakerFi 项目）

面向攻防演练/护网背景的同学，把本仓库当成“目标系统”，以传统渗透测试流程（目标→漏扫→渗透→横向→提权→报告）为骨架，提供可跑的步骤、断言与证据归档指南。

## 一、目标（Target）
- 评估对象：
  - 金库与路由：`contracts/core/Vault.sol`、`VaultRouter.sol`、`MultiCommand.sol`
  - 策略聚合：`contracts/core/MultiStrategy.sol` 及 `core/strategies/*`
  - 预言机：`contracts/oracles/*`（Pyth/Ratio/ExRate）
  - 升级与代理：`contracts/proxy/BakerFiProxy.sol`
- 资产与边界：聚焦本地/测试网，使用 `contracts/mocks/*` 与 `test/*` 做复现，不对主网或生产环境执行。
- 成功标准：能复现并检测典型风险（重入、闪电贷组合、批处理越权、预言机异常、升级存储不兼容、参数误配置），形成审计证据链与处置建议。

## 二、漏扫（Vulnerability Scanning）
目标：快速发现结构性问题、编码规范问题与潜在存储/升级风险。

- 静态分析（Slither）：
  - 命令：`npm run slither` 或 `slither --config-file ./slither.config.json .`
  - 配置：`slither.config.json` 已过滤部分 mocks 与第三方依赖，便于聚焦关键模块。
  - 关注项：重入可疑点、未校验返回值、危险的外部调用、`delegatecall`/代理升级相关。
- 规则检查（Solhint/Hardhat Lint）：
  - 命令：`npm run solhint:check`、`npx hardhat check`
  - 关注项：可见性、事件、命名与安全相关规则是否达标。
- 合约体积与选择器：
  - 命令：`npm run contract:size`、`npm run export:selectors`
  - 关注项：过大的字节码影响部署与升级；选择器稳定性。
- 存储布局与升级兼容：
  - 命令：`npx hardhat storage-layout --update`
  - 检查：`npx hardhat storage-layout --check`
  - 文档：`doc/storage-compatibility.md`、`doc/proxy/*`

输出物：静态分析报告、lint 结果、体积与选择器清单、存储布局比对报告。

## 三、渗透（Exploitation / PoC）
目标：在本地/测试网以最小 PoC 复现可疑行为，验证断言。

- 测试与覆盖：
  - 全量测试：`npx hardhat test`
  - 指定场景：`npx hardhat test -- test/core/BalancerFlashLoan.ts`
  - 覆盖率：`npm run test:coverage` 或 `npx hardhat coverage`
  - Gas：`npm run test:gas` 或 `REPORT_GAS=true npx hardhat test`
- 本地部署与脚本：
  - 启动本地链：`npm run ganache:dev`
  - 部署：`npm run deploy:local` 或 `npx hardhat --network localhost run scripts/deploy-dev.ts`
  - 交互任务：`scripts/tasks/*`（读取/写入设置、策略参数等）
- 典型 PoC 列表与入口：
  - 闪电贷组合操作：`test/core/BalancerFlashLoan.ts`，观察短时大额状态扰动与断言。
  - 重入与外部回调：`contracts/mocks/BorrowerAttacker.sol` + `test/hooks/UseTokenActions.test.ts`，验证“检查-效果-交互”。
  - 路由批处理越权：`contracts/core/VaultRouter.sol`、`MultiCommand.sol` + `contracts/mocks/VaultRouterMock.sol`，构造命令序列与参数边界。
  - 预言机异常与操纵：`contracts/mocks/OracleMock.sol`、`PythMock.sol` + `test/oracles/*`、`test/pyth/*`，验证新鲜度、偏差、回退。
  - 升级/代理安全：`contracts/proxy/BakerFiProxy.sol` + `test/proxy/*`，验证实现替换与存储兼容。

证据点：事件序列、余额变化、回滚原因、价格时间戳与偏差、升级后变量布局一致性。

## 四、横向（Lateral Movement）
目标：从一个入口移动到其他模块，评估跨合约调用链的安全性。

- 入口与路径：`VaultRouter` → `MultiStrategy` → 具体策略与外部协议（DEX/借贷）。
- 方法：利用批处理命令或脚本触发多跳调用，观察各跳的权限与参数校验。
- 演练：结合 `test/hooks/Leverage.ts` 与路由测试，用最小输入集构造多步操作，检查每一步断言与事件。
- 风险要点：参数在多个模块间传递时的校验一致性、意外的外部状态依赖。

输出物：多跳调用的调用图、事件时间线、边界与断言清单。

## 五、提权（Privilege Escalation）
目标：评估治理/角色/参数修改与代理升级是否可能被滥用或误配置。

- 治理与角色：
  - 关注 `GovernableOwnable.sol`、`VaultRegistry.sol`，检查 `owner/admin/governance` 边界。
  - 尝试在本地链用非授权账户执行 `scripts/tasks/settings.ts`、`strategy.ts`、`vault.ts` 的写操作，期望回滚并记录原因。
- 参数与费率：
  - 示例命令（需使用授权账户）：
    - 读取/设置绩效费：`npx hardhat --network local settings:getPerformanceFee`／`settings:setPerformanceFee --value <val>`
    - 读取/设置取款费：`npx hardhat --network local settings:getWithdrawalFee`／`settings:setWithdrawalFee --value <val>`
    - 策略 LTV 与回路数：`npx hardhat --network local strategy:getLoanToValue`／`strategy:setLoanToValue --value <val>`，`strategy:getNrLoops`
- 升级与代理：
  - 验证升级脚本：`scripts/upgrade-*.ts` 与 `scripts/verify.ts`
  - 存储兼容检查：`npx hardhat storage-layout --check`，对比 `doc/storage-compatibility.md`

输出物：权限与事件证据、参数修改日志与断言、升级前后布局与选择器比对。

## 六、报告（Reporting）
目标：将发现与复现过程结构化输出，便于修复与验收。

- 报告结构：
  - 执行摘要：范围、关键发现、风险等级与建议。
  - 发现条目：问题描述、影响分析、复现步骤（命令+输入）、证据材料（日志/事件/覆盖率/静态报告）、修复建议。
  - 演练日志：按阶段记录命令与输出，保留交易哈希与事件时间线（如使用本地链则保存脚本日志）。
- 严重性分级：高（资金风险/跨模块影响）、中（配置/参数导致风险提升）、低（难利用或影响有限）。
- 验收标准：
  - PoC 不可复现或断言全部通过；
  - 覆盖率达到阈值（自定，如 ≥80% 行覆盖）；
  - 静态分析无高危项；
  - 升级检查与本地部署交互顺利。
- 归档与版本固定：
  - 固定 Node/NPM/Hardhat/OS 版本与 `package-lock.json`；
  - 保存 `coverage/`、Gas 输出、`slither.report.*`、`echidna.*`、部署与任务日志；
  - 输出命令-目的-产物清单（建议 Markdown/JSON）；必要时添加 `.env.example`。

## 七、最小演练清单（Windows/PowerShell）
- 初始化：
  - `npm ci`
  - `npx hardhat compile`
- 漏扫：
  - `npm run slither`，`npm run solhint:check`，`npx hardhat check`
  - `npx hardhat storage-layout --update`／`--check`
- 渗透：
  - `npx hardhat test -- test/core/BalancerFlashLoan.ts`
  - `npm run test:coverage`，`npm run test:gas`
- 横向：
  - `npx hardhat test -- test/hooks/Leverage.ts`（多跳与策略联动）
- 提权：
  - `npm run ganache:dev` → `npm run deploy:local`
  - 使用 `scripts/tasks/*` 读取/写入参数，验证权限与事件
- 归档：
  - 保存报告与输出目录，固定版本信息

## 八、注意事项（安全与伦理）
- 仅在本地/测试网执行，避免对主网或外部系统造成影响。
- 对潜在问题采取负责任披露流程；对外公开的材料应去敏与脱密。

## 附录：命令-目的-产物（示例）
- `npm ci`：安装依赖 → 产物：`node_modules/`
- `npx hardhat compile`：编译合约 → 产物：`artifacts/`、`cache/`
- `npx hardhat test -- test/core/BalancerFlashLoan.ts`：闪电贷 PoC → 产物：测试日志、断言结果
- `npm run test:coverage`：覆盖率 → 产物：`coverage/`
- `npm run test:gas`：Gas → 产物：控制台输出或报告文件
- `npm run slither`：静态分析 → 产物：分析报告
- `npx hardhat storage-layout --check`：存储兼容 → 产物：比对结果
- `npm run ganache:dev` → `npm run deploy:local`：本地链与部署 → 产物：合约地址与事件日志
- `npx hardhat run scripts/verify.ts --network <net> -- <strategy>`：验证合约 → 产物：区块浏览器验证结果

——
把以上流程当成一次“红队对链上系统的演练”，你可以从最小 PoC 开始，逐步扩展到横向与提权，并在报告中输出可复现的证据与修复建议。该手册与本仓库的测试与脚本已对齐，直接复制命令即可上手。