#  合约审计新手入门（面向护网背景）

本指南面向从攻防演练/护网转入 Web3 的同学，帮助你迅速建立合约审计的心智模型、掌握核心概念与落地方法，并用本仓库作为练习场进行可复现的实操。

## 一、你需要的心智模型（从传统攻防到链上）
- 状态机与交易驱动：合约是链上状态机，只有交易触发状态变化；没有“后台服务”，一切以调用为中心。
- 信任边界变化：信任的不是“网络边界”，而是“合约代码与权限体系”（`owner/admin/governance`）。
- 可见与不可变：链上代码与状态可读（公开），代码一旦部署很难修改（除非可升级代理），审计要考虑“长期暴露”。
- 经济与时序：攻击不只技术层面，还涉及价格、滑点、清算、挤兑、MEV 等经济与时序因素。
- EVM 与 Gas：每个操作都耗费 Gas；大量循环、外部调用会受限制，DoS 与经济不可行性需要评估。

## 二、必知概念与术语（速查）
- `EVM`：以太坊虚拟机，合约的运行环境。
- `msg.sender` 与 `tx.origin`：调用者与交易发起者，审计中严禁使用 `tx.origin` 鉴权。
- `reentrancy`（重入）：外部调用在未更新状态前又回调本合约，导致不一致或盗取资产。
- `delegatecall`/代理：用调用者的上下文执行被调用代码，易引发存储碰撞与权限绕过。
- 存储布局（storage layout）：变量在插槽中的顺序与占位，升级时必须保持兼容。
- 预言机（oracle）：价格/数据来源，需防操纵与陈旧数据。
- 闪电贷（flash loan）：同一交易内无抵押借款并归还，常用于价格操纵与复杂攻击。
- `permit`/签名：离线签名授权转账或操作，注意重放与域分离。
- 不变量（invariants）：审计要保证始终成立的性质，如资金守恒、额度不超限。

## 三、常见风险图谱（你要特别警觉）
- 权限与初始化：错误的所有权转移、未初始化、缺少访问控制。
- 重入与外部调用：从外部合约回调导致状态错乱，未遵循 `checks-effects-interactions`。
- 代理与升级：`delegatecall` 滥用、存储布局变更、升级后事件与接口不一致。
- 价格与预言机：数据陈旧、操纵门槛低、单源依赖、缺乏限幅与回退。
- 经济与 DoS：Gas 不可承受、批处理规模无上限、失败路径成本过高。
- 精度与数学：舍入误差、比例换算、`ERC20` 小数不一致、`ERC4626` 资产/份额对应关系。
- 参数与边界：未校验的输入、越权的命令序列、规模/额度未限制。

## 四、在本仓库的实操路径
目录地图（关键位置）：
- 合约主体：`contracts/core/*`、`contracts/oracles/*`、`contracts/proxy/*`
- 模拟与 PoC：`contracts/mocks/*`（如 `BorrowerAttacker.sol`、`VaultRouterMock.sol`）
- 测试：`test/*`（如 `test/core/BalancerFlashLoan.ts`、`test/oracles/*`、`test/proxy/*`）
- 部署与任务：`scripts/*.ts`、`scripts/tasks/*`
- 配置与报告：`hardhat.config.ts`、`slither.config.json`、`echidna.yaml`

标准命令（Windows/PowerShell）：
- 安装依赖：`npm ci`
- 运行全部测试：`npx hardhat test`
- 运行覆盖率：`npx hardhat coverage`
- 生成 Gas 报告：`REPORT_GAS=true npx hardhat test`
- 本地部署演练：`npx hardhat --network localhost run scripts/deploy-dev.ts`

建议学习顺序：
1) 先跑测试与覆盖率，观察 PoC 断言与日志；
2) 阅读 `contracts/mocks/*` 与对应测试，理解攻击/误用模拟；
3) 选择一个方向深入（如闪电贷或路由批处理），沿测试到合约实现；
4) 尝试添加一个断言或负测试，验证你的理解。

## 五、快速 PoC 设计法（落地）
- 选定性质：如“资金不可被非授权主体转走”“极端价格下拒绝交易”。
- 找到触发面：函数与参数、外部调用位置、事件与日志。
- 最小复现：用 mocks 或本地部署复现实例，精简到最小输入集。
- 写断言：余额变化、权限检查、回滚原因、事件是否发出。
- 输出工件：命令、日志、报告（覆盖/Gas/静态分析）统一归档。

示例（本仓库）：
- 闪电贷 PoC：参考 `test/core/BalancerFlashLoan.ts` 与 `contracts/mocks/BorrowerAttacker.sol`，观察回调路径与资产变化断言。
- 路由批处理 PoC：参考 `contracts/mocks/VaultRouterMock.sol` 与 `test/core/vault/*`（如存在），验证命令序列与参数边界。
- 预言机异常 PoC：参考 `test/oracles/*` 与 `contracts/oracles/*`，构造价格偏差并验证风控。
- 代理/升级安全：参考 `test/proxy/*` 与 `contracts/proxy/*`，检查存储兼容与状态保持。

## 六、工具清单（最小闭环）
- Hardhat：测试、覆盖率、Gas 报告；命令见上。
- Slither：静态分析（需安装），示例命令：`slither . --config slither.config.json`。
- Echidna（可选）：性质测试，配置示例见 `echidna.yaml`。
- Tenderly（可选）：可视化调试与调用轨迹回放。

## 七、审计检查清单（简版）
- 访问控制：初始化、所有权/管理员、仅限受信主体。
- 重入与外部调用：遵循 `checks-effects-interactions`，必要时引入 `ReentrancyGuard`。
- 资金与精度：`approve/transferFrom` 竞态、`permit`、小数与舍入、`ERC4626` 一致性。
- 代理与升级：`delegatecall` 使用、存储布局对照、事件/选择器兼容、治理流程验证。
- 预言机：新鲜度、偏差上限、回退与多源聚合、操纵门槛评估。
- 路由与批处理：命令序列与参数校验、规模限制、错误处理与回滚原因一致性。
- 经济与 DoS：关键路径 Gas、失败路径成本、批量/迭代规模影响。

## 八、学习里程碑建议（循序渐进）
- 里程碑1：跑通测试与覆盖率，理解日志与断言。
- 里程碑2：完成一个 PoC 的最小复现（闪电贷/路由/预言机任选）。
- 里程碑3：补充一条断言或边界用例，提交报告（覆盖+Gas）。
- 里程碑4：完成一次静态分析并归档发现与修复建议。
- 里程碑5：尝试一次升级/存储兼容性检查并形成对照表。

## 九、伦理与安全（务必遵守）
- 仅在本地或测试网演练，不将 PoC 用于主网或生产环境。
- 发现问题遵循负责任披露流程，先私下沟通修复再公开。
- 报告与日志做去敏处理，避免泄露隐私与密钥。

如需，我可以把这份入门与“Solidity智能合约审计样板”串联起来，生成一份最小可跑的审计复现包（`.env.example` + 命令脚本 + 报告骨架），帮助你马上开始实操。