# 🧭 Solidity 审计工具矩阵（含框架说明）

本文档为 Solidity 安全审计提供标准化工具体系，  
特别适用于 **BakerFi Mitigation Review** 等多模块 DeFi 项目。  
涵盖开发、分析、验证、报告等全流程工具说明。

---

## 🧱 一、完整审计工具矩阵（含框架说明）

| 工具 / 框架 | 类型 | 功能与用途 | 框架说明（核心原理 / 特点） |
|--------------|------|-------------|------------------------------|
| **Hardhat** | 🧩 开发 / 测试框架 | 编译、部署、单元测试、模拟链交互 | Solidity 最主流开发框架之一，支持 TypeScript 测试、Ethers.js 集成，可快速本地 fork 主网复现漏洞。 |
| **Foundry** | ⚙️ 高速测试 / Fuzz 框架 | 快速 fuzz、断言、gas 测试 | 基于 Rust，速度极快（≈ Hardhat 的 5–10 倍），可通过 `forge test` 模拟复杂状态；非常适合验证修复漏洞是否彻底。 |
| **Slither** | 🧠 静态分析引擎 | 检测代码结构、权限控制、潜在漏洞 | Trail of Bits 出品，基于 AST 解析器（Python），能快速扫描 reentrancy、未使用变量、无访问控制函数等问题。 |
| **Semgrep** | 🔍 模式匹配审计工具 | 基于规则检测常见漏洞模式 | 轻量级代码安全分析框架，支持自定义规则（YAML），能检测“未校验输入”“unchecked call”“allowance误用”等问题。 |
| **Mythril** | 🧮 字节码符号执行器 | 检查逻辑分支安全性、溢出、可达性 | 通过符号执行（SMT Solver）模拟所有路径执行，能捕捉低级逻辑错误（尤其适用于 call.value / delegatecall 类漏洞）。 |
| **Echidna** | 🧫 模糊测试 / Invariant 检查 | 反复执行合约状态变换以验证不变量 | Trail of Bits 出品，适合检测资金守恒、无溢出、权限不越界等“永真命题”（invariant）。 |
| **Solidity-Coverage** | 📊 测试覆盖率分析 | 检查修复代码是否被测试触达 | 通过插桩（instrumentation）计算测试覆盖率；Mitigation Review 必用，用于验证 PR 修复逻辑是否有对应测试。 |
| **Hardhat Gas Reporter** | ⚡ 性能分析 | 统计函数 Gas 消耗、优化性能 | 在测试运行时统计每函数 gas 用量；对 DoS 与 gas 上限问题极有帮助。 |
| **Surya** | 🧩 合约结构分析 | 生成函数调用图 / 依赖图 | 由 ConsenSys 出品，可输出 `.dot` 文件；适合梳理 Vault–Strategy 调用路径，理解系统架构。 |
| **Solhint / ESLint** | 🧱 代码风格与复杂度检测 | 提示不规范语法与复杂度风险 | 用于检测函数是否过长、缺注释、变量命名不规范，有助于 PR 代码风格审查。 |
| **Git Diff / VSCode Diff** | 🔎 修复验证工具 | 对比修复前后差异，验证漏洞是否关闭 | 基础但关键，所有 Mitigation Review 的核心动作；可生成差异报告。 |
| **Cursor / ChatGPT 辅助分析** | 💬 AI 辅助理解 | 自动生成函数依赖、diff解读、漏洞分析 | 用于快速理解大文件差异和调用链，显著加快代码阅读与验证速度。 |
| **Draw.io / Obsidian Graph** | 🧭 逻辑可视化 | 绘制资金流与权限矩阵 | 用于手动构建 Vault–Strategy–Router 的状态图，辅助发现逻辑漏洞。 |
| **Markdown / Typora / Obsidian** | 🧾 报告撰写 | 输出复盘与分析报告 | 用于整理最终的漏洞验证报告与通关笔记，统一格式与截图。 |
| **Python / Bash 脚本** | 🧰 自动化脚本 | 自动跑测试、生成 diff、日志化 | 审计工作流自动化，用于批量分析 19 个 PR 修复情况。 |

---

## 🧠 二、工具分层逻辑（框架架构观）

| 层级 | 工具集 | 框架说明 | 在 BakerFi 中的应用 |
|-------|----------|--------------|----------------------|
| 🧩 **执行层（Execution Layer）** | Hardhat, Foundry, Gas Reporter | 用于跑合约、复现漏洞、验证修复 | 跑 deposit/withdraw/rebalance，测试修复是否生效 |
| 🔍 **静态分析层（Static Analysis Layer）** | Slither, Semgrep, Surya | 无需运行，解析AST/CFG找隐患 | 快速定位函数调用链、权限未封装、reentrancy风险 |
| ⚙️ **符号与模糊层（Symbolic/Fuzz Layer）** | Mythril, Echidna | 自动探索路径、随机状态测试 | 验证资金守恒、撤回逻辑不破坏invariant |
| 🧮 **验证与回归层（Diff & Coverage）** | Git Diff, Solidity-Coverage | 确认修复代码是否触发与覆盖 | Mitigation 核心：验证修复有效性 |
| 💡 **辅助理解层（Visualization & AI）** | Cursor, GPT, Draw.io | 帮助快速理解复杂架构 | 自动生成调用图、资金流图 |
| 🧾 **文档与报告层（Documentation Layer）** | Markdown, Obsidian | 产出专业审计报告 | 撰写每个 PR 的验证说明 |

---

## ⚙️ 三、核心推荐组合（黄金 5 件套）

| 组合 | 说明 | 用途 |
|------|------|------|
| **Hardhat + Foundry** | 同时拥有 JS 测试 + 高速 fuzz 能力 | 构造场景与快速验证修复 |
| **Slither + Semgrep** | 逻辑分析 + 模式匹配双引擎 | 自动检测大部分中高危漏洞 |
| **Git Diff + Coverage** | 验证修复是否闭合 | Mitigation Review 专用 |
| **Cursor + GPT** | 代码理解提速 10 倍 | 辅助阅读 PR、生成依赖图 |
| **Markdown / Obsidian** | 输出通关文档 | 最终报告与 Portfolio 展示 |

---

## 🔗 四、项目映射（BakerFi 专用）

- 执行层（Hardhat / Tests）
  - 代码入口：`test/*`（TypeScript 测试）、`scripts/*.ts`（部署/操作）与 `scripts/tasks/*`（运维任务）。
  - 典型动作：`deposit.ts`、`tasks/router.ts`、`tasks/vault.ts`、`tasks/settings.ts`、`upgrade-*.ts`。
  - 目标用例：存取款、批处理（MultiCommand/MultiStrategy）、预言机更新、策略再平衡、升级验证。
- 静态分析层（Slither / Surya / Semgrep）
  - 配置：`slither.config.json`；分析目标：`contracts/core/*`、`contracts/oracles/*`、`contracts/proxy/*`。
  - 用途：函数调用与权限矩阵（Surya），未封装的外部调用、reentrancy 可疑点（Slither），常见模式误用（Semgrep）。
- 符号与模糊层（Echidna / Mythril）
  - Echidna：`echidna.yaml`；绑定不变量（建议）：资金守恒、份额价格单调、提现可用性、批处理原子性、预言机极值/延迟保护。
  - Mythril：对关键代理/权限/批处理路径做符号执行（可选）。
- 覆盖与性能（Coverage / Gas Reporter）
  - Coverage：集成 `solidity-coverage`（Hardhat 插件）以验证修复逻辑是否被测试覆盖。
  - Gas Reporter：集成 `hardhat-gas-reporter`，观测 `deposit/withdraw/rebalance` 的 gas 边界与潜在 DoS 风险。
- 可视化与辅助（Surya / Draw.io / AI）
  - Surya 生成 `.dot` 调用图；Draw.io 绘资金流与权限矩阵；AI 用于 diff 与依赖梳理。

## 🧭 五、优先级与执行顺序（建议）

- Mitigation Review（针对修复验证）
  - 1) Slither 基线扫描 + Surya 调用图梳理（定位风险模块与路径）。
  - 2) Hardhat 测试跑通关键场景（`test/*`），补充缺失用例；集成 Coverage 验证触达率。
  - 3) 针对资金/权限/批处理，选 3–5 条不变量写 Echidna 用例（小而准）。
  - 4) Gas Reporter 观测关键路径 gas；出报告（差异/覆盖/事件与余额对照）。
- Full Audit（系统性审计）
  - 1) 结构与权限建模（Surya + 手工矩阵）。
  - 2) Slither/ Semgrep 规则扩展，覆盖 SWC 高发项与项目特有模式。
  - 3) Echidna 全局不变量与状态机一致性；Mythril 选取关键分支符号执行。
  - 4) 覆盖率与性能基线；运营脚本与升级证据链核对。

## 🚀 六、Quickstart（命令示例）

- Slither（静态分析）
  - 示例：`slither . --config-file slither.config.json`
- Hardhat（测试与覆盖）
  - 示例：`npx hardhat test`；集成覆盖后：`npx hardhat coverage`
- Echidna（不变量）
  - 示例：`echidna-test . --config echidna.yaml`
- Surya（调用图）
  - 示例：`surya graph contracts/core/Vault.sol --output vault.dot`
