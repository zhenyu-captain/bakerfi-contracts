# 工程化验证与实验操作手册（BakerFi 合约）

本文件按“先写总目标 → 再列小目标 → 最后逐个目标的具体任务”的结构组织，确保研究与实验可落地、可复现、可评估。

## 一、总目标

- 产出一篇贴近实践的工程化研究论文，围绕 BakerFi 合约在多策略聚合、批处理路由、预言机集成、可升级代理等场景下的安全验证方法与实验结果，形成可复现的证据链与清晰的结论。
- 搭建标准化的实验环境与运行流程，提供“一键复现”与明确的度量指标（测试通过率、覆盖率、Gas 成本、异常触发阈值等）。
- 梳理并实现可复现的 PoC 场景，覆盖闪电贷/恶意交互、路由批处理误用、预言机异常、升级兼容性、策略参数边界等关键威胁模型。

## 二、小目标（分解）

1. 定义研究范围与核心问题
2. 梳理威胁模型与安全性质
3. 规划实验环境与复现要求
4. 选择 PoC 场景并设计断言
5. 制定度量指标与数据收集方案
6. 设计实验流程与命令清单
7. 整理报告模板与论文提纲
8. 明确伦理与披露流程
9. 规划结果归档与版本固定
10. 设定里程碑与验收标准

---

## 三、每个目标的具体任务

### 1) 定义研究范围与核心问题
- 明确被测对象：`Vault`、`MultiStrategy`、`VaultRouter`、`Oracles`、`Proxy`。
- 选定关注面：闪电贷、路由组合、预言机异常、升级兼容、策略参数边界。
- 陈述研究问题与预期结论口径：工程可验证、安全边界、成本权衡。
- 输出：1 页范围说明与问题列表（Markdown）。

### 2) 梳理威胁模型与安全性质
- 列出攻击面：恶意借款人、命令注入/错误参数、价格操纵、升级破坏。
- 定义安全性质：资金不当转移拒绝、命令序列约束、价格异常风控、存储布局一致性。
- 明确失败判据：交易回滚、断言失败、余额偏差超阈、状态不一致。
- 输出：威胁模型与性质表（Markdown/表格）。

### 3) 规划实验环境与复现要求
- 指定 Node/NPM/Hardhat/OS 版本与安装方式：`npm ci` 固定依赖。
- 准备 `.env.example`（仅本地/测试网 RPC、私钥占位）。
- 依赖工具：`hardhat-coverage`、`gas-reporter`、`slither`（可选）、`echidna`（可选）。
- 输出：环境要求与安装说明、复现前置条件（Markdown）。

### 4) 选择 PoC 场景并设计断言
- 闪电贷交互：借款人回调触发、资产变化与防护路径断言。
- 路由批处理：命令组合输入记录与权限/参数校验断言。
- 预言机异常：价格偏差下的拒绝或限幅行为断言。
- 升级安全：存储布局一致性与状态保持断言。
- 策略边界：参数越界、配额/风控阈值触发。
- 输出：每个场景的触发参数、预期行为、关键日志或函数映射表。

### 5) 制定度量指标与数据收集方案
- 测试通过率与失败类型分布（按场景/模块）。
- 覆盖率（行/分支），Gas 成本（关键函数/场景）。
- 异常触发的最小条件与参数敏感性。
- 统一记录格式与归档规范（JSON/Markdown/HTML）。
- 输出：度量项定义与采集脚本路径/命令。

### 6) 设计实验流程与命令清单
- 顺序：单场景→全量测试→覆盖率→气体→静态/性质→本地部署任务。
- 标准命令：
  - `npx hardhat test`（全量或按目录）
  - `npx hardhat coverage`（覆盖率报告）
  - `REPORT_GAS=true npx hardhat test`（Gas 报告）
  - `npx hardhat --network localhost run scripts/deploy-dev.ts`（本地部署）
- 输出：命令-目的-产物清单（Markdown 表）。

### 7) 整理报告模板与论文提纲
- 章节骨架：引言、系统与实现、方法（PoC）、实验设置、结果、讨论、局限与未来工作、复现与工件、伦理、结论。
- 图表清单：架构图、存储布局对照、Gas 直方图、PoC 成败堆叠图。
- 附录结构：命令清单、参数表、用例-断言映射、版本记录。
- 输出：论文提纲与报告模板（Markdown/LaTeX 可选）。

### 8) 明确伦理与披露流程
- 仅在本地或测试网运行 PoC，避免主网风险。
- 潜在问题的负责任披露流程与时序安排。
- 数据与脚本公开范围与去敏处理。
- 输出：伦理说明与披露步骤（Markdown）。

### 9) 规划结果归档与版本固定
- 固定 commit/tag、Node/NPM/Hardhat/OS 版本。
- 保存 `coverage/`、Gas 输出、Slither/Echidna 报告、部署任务日志。
- 提供 `.env.example` 与“一键实验”说明。
- 输出：归档清单与版本固定指南。

### 10) 设定里程碑与验收标准
- 里程碑：PoC 场景定义→跑通单场景→全量测试→报告生成→论文初稿→定稿。
- 验收：命令全部可跑、关键断言一致、度量报告完整、附录可复现。
- 输出：里程碑计划与验收条目（Checklist）。

---

## 四、附：推荐的目录/文件关联（便于落地）
- 被测对象参考位置：`contracts/core/*`、`contracts/oracles/*`、`contracts/proxy/*`、`contracts/mocks/*`
- 测试与 PoC 参考：`test/core/*`、`test/oracles/*`、`test/proxy/*`、`contracts/mocks/*`
- 部署与任务：`scripts/*.ts`、`scripts/tasks/*`
- 报告与配置：`hardhat.config.ts`、`slither.config.json`、`echidna.yaml`

如需，我可以继续为每个小目标生成对应的简表和可直接复制执行的命令与模板。