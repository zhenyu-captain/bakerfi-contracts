# 合约审计样板

本样板提供“总目标 → 小目标 → 每个目标的具体任务”的清晰结构，便于快速开展、复用与验收 Solidity 智能合约审计工作。可直接套用到不同项目，并结合本仓库中的示例与工具链执行。

## 一、总目标

- 形成一套可复用、可落地、可复现的审计方法论与工件产出流程，覆盖范围定义、威胁模型、静态/动态分析、PoC 设计、不变量测试、升级与存储安全、报告与披露。
- 以工程化方式固化审计证据链：结论、复现实验、度量数据、代码片段、配置与报告均可一键获取与归档。
- 明确审计交付标准（报告结构、严重性分级、修复建议、复现命令、版本与环境固定）。

## 二、小目标（分解）

1. 审计范围与假设
2. 安全性质与威胁模型
3. 架构映射与资产清单
4. 静态分析与规范检查
5. 测试体系与 PoC 设计
6. 不变量与性质测试（Fuzz/Property）
7. 升级与存储兼容性审计
8. 经济性与 DoS 评估
9. 报告模板与证据链归档
10. 复现与伦理披露流程

---

## 三、每个目标的具体任务

### 1) 审计范围与假设
- 明确 In/Out-of-Scope：合约列表、外部依赖、网络环境（主网/测试网/本地）。
- 角色与边界：`owner/admin`、`governance`、`router`、`strategy`、`oracle` 等权限主体与信任边界。
- 前置假设：价格来源可信度、第三方协议行为、链上时序与 MEV 风险。
- 输出：范围说明（Markdown）、合约与依赖清单、威胁边界图。

### 2) 安全性质与威胁模型
- 资产与不变量：资金守恒、费用与收益结算一致、状态机合法迁移。
- 攻击面归纳：重入、权限绕过、逻辑注入、价格操控、闪电贷、委托调用、存储碰撞、整数与精度问题、DoS、签名/许可滥用等。
- 安全性质定义：拒绝资金不当转移、命令序列约束、价格异常风控、升级后状态与布局一致性、额度与限幅生效。
- 输出：威胁模型与性质表（含失败判据：回滚、断言失败、余额偏差超阈、状态不一致）。

### 3) 架构映射与资产清单
- 架构图与数据流：模块关系、调用路径、外部协议依赖、关键存储槽位与变量。
- 资产清单：代币、金库、策略、路由、预言机、代理与管理员、参数与阈值。
- 交互面：对外接口（Selectors）、事件、任务脚本、部署参数。
- 输出：架构映射文档、资产与参数清单、接口与事件索引。

### 4) 静态分析与规范检查
- 编译器与语言约束：`solc` 版本固定、优化开关、`viaIR`、`abicoder v2` 等。
- 代码规范：`solhint`/`eslint`（TS 部分）、命名与可读性、错误信息一致性。
- 静态分析工具：`Slither`、可选 `Mythril`/`Securify`，生成发现与分类。
- 常见模式检查：`reentrancy`、`access control`、`delegatecall`、`selfdestruct`、`tx.origin`、`unchecked`、`abi.encode`、时间/区块依赖、事件与索引字段一致性。
- 输出：静态分析报告、规范检查结果与修复建议清单。

### 5) 测试体系与 PoC 设计
- 单元与集成测试：正/负路径、边界条件、异常处理与回滚验证。
- PoC 归类：闪电贷/恶意借款人、路由批处理误用、预言机异常、权限绕过、参数越界。
- 断言设计：资产变化、权限检查、回滚原因、日志事件、最小触发条件。
- 命令与脚本：`npx hardhat test`、覆盖指定目录与用例；必要时 Foundry/Hardhat 双栈。
- 输出：测试与 PoC 用例列表、断言矩阵、运行命令与报告链接。

### 6) 不变量与性质测试（Fuzz/Property）
- 性质定义：资金守恒、赎回-存款关系、费率与折算一致性、阈值与上限不被突破。
- 工具链：`echidna`/Foundry invariants，参数域与约束设定，种子与迭代次数。
- 成败判据：性质违反、触发路径记录、最小反例输出。
- 输出：性质规格文件、测试配置与报告、最小反例（如有）。

### 7) 升级与存储兼容性审计
- 代理模式：`TransparentUpgradeableProxy`/自定义代理，`Admin`/`ProxyAdmin` 权限与限制。
- 存储布局：`storage gap`、插槽顺序、继承链、删除/新增变量的影响与兼容策略。
- 升级回归：状态保持与接口兼容、事件与选择器一致性、治理流程验证。
- 输出：存储布局对照表、升级模拟与回归结果、兼容性结论与建议。

### 8) 经济性与 DoS 评估
- Gas 成本：关键路径、上限场景、失败路径成本，是否存在经济不可行或拒绝服务风险。
- 经济攻击面：价格滑点、操纵门槛、清算与挤兑、跨模块互斥导致的阻塞。
- 资源限制：迭代与批处理规模、事件日志体积、栈深与代码尺寸。
- 输出：Gas 报告、DoS 风险评估与缓解建议、规模与参数限制表。

### 9) 报告模板与证据链归档
- 报告结构：摘要、范围、方法、发现（严重性分级）、修复建议、受影响组件、复现实验、局限与未来工作、附录。
- 严重性分级：`Critical/High/Medium/Low/Informational` 与打分准则（影响×可利用性×普遍性）。
- 证据链：代码引用、日志与事件、命令与版本、覆盖率/Gas/静态分析报告、配置与脚本。
- 输出：审计报告模板（Markdown/LaTeX）、发现条目格式、证据链归档结构与命名规范。

### 10) 复现与伦理披露流程
- 复现保证：固定 `commit/tag`、环境与依赖版本、`.env.example` 与一键脚本。
- 开放程度：公开报告与脚本的范围、去敏与隐私处理、保留内部工单链接（如有）。
- 披露流程：私下沟通窗口与时序、修复验证与复审、公开披露节奏与条件。
- 输出：复现手册、披露 SOP、合规与伦理说明。

---

## 四、附：审计检查清单速览（可扩展）
- 权限：仅限受信主体可调用；初始化与所有权转移安全；紧急/暂停机制。
- 重入：外部调用后写状态、跨模块重入保护、`checks-effects-interactions`。
- 资金与资产：`approve/transferFrom` 竞态、`permit`/签名重放、`ERC20` 小数与舍入、`ERC4626` 一致性。
- 代理与升级：`delegatecall` 使用、存储布局变更、事件与选择器兼容、升级治理流程。
- 预言机：价格新鲜度、偏差与限幅、回退与多源聚合、操纵门槛。
- 路由与批处理：命令序列校验、越权风险、参数边界与规模限制。
- 错误处理：标准化 `revert` 原因、边界与异常覆盖、日志与事件一致性。
- 经济与 DoS：气体上限、失败路径成本、清算/挤兑/批量规模风险。

## 五、工具与目录建议（可据项目调整）
- 工具：Hardhat/Foundry、Slither、hardhat-coverage、gas-reporter、Echidna（可选）、Tenderly（可选）。
- 目录：
  - 合约：`contracts/*`
  - 测试/PoC：`test/*` 与 `contracts/mocks/*`
  - 部署与任务：`scripts/*.ts`、`scripts/tasks/*`
  - 配置与报告：`hardhat.config.ts`、`slither.config.json`、`echidna.yaml`

如需，我可以将此样板进一步细化为“可拷贝的审计报告模板与命令清单”，并生成 `.env.example` 与一键脚本以保证复现与归档的一致性。