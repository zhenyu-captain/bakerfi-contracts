# 审计前统一概念框架（BakerFi）

目标：在动手审计之前，一次性弄清“这个项目是做什么的、涉及哪些概念、这些概念在代码与运行中的实际含义是什么”，并给出类似 ATT&CK 的覆盖框架与最小验证清单。

---

## 1. 项目到底在做什么（一句话）

- BakerFi 是一个“可升级的多策略金库平台”。用户通过 `VaultRouter` 发起存取款与批处理命令，资产进入 `Vault/MultiStrategyVault` 后由多个策略（对外协议如 Aave/Curve/Uni）组合管理；价格与比率通过多种预言机获取；参数由 `VaultSettings` 管控；地址目录由 `VaultRegistry` 维护；升级通过代理（`BakerFiProxy` + `ProxyAdmin`）进行；所有动作可由脚本（`scripts/`）触达与运维。

---

## 2. 核心概念与实际含义（概念卡）

以下每条都给出：是什么/用来干啥/在哪里看/运维入口/不变量与常见问题。

- Vault / VaultBase / MultiStrategyVault
  - 是什么：金库产品（ERC-4626 等价模型），维护资产与份额，支持多策略组合。
  - 用途：承接用户存取款、策略分配、再平衡与收益归集。
  - 哪里看：`contracts/core/Vault.sol`、`contracts/core/VaultBase.sol`、`doc/core/Vault.md`、`doc/core/MultiStrategyVault.md`。
  - 运维入口：`scripts/tasks/vault.ts`（若有）、策略相关 `scripts/tasks/strategy.ts`。
  - 不变量/常见问题：`totalAssets/totalSupply` 一致性；费用扣取路径；份额会计；多策略之间资产对账与残余清扫。

- VaultRouter / MultiCommand
  - 是什么：统一的对外入口与批处理命令执行器，负责参数映射与状态机控制。
  - 用途：将多步操作以一个批次执行，减少多个交易的摩擦与状态漂移。
  - 哪里看：`contracts/core/VaultRouter.sol`、`contracts/core/MultiCommand.sol`、`doc/core/VaultRouter.md`、`doc/core/MultiCommand.md`。
  - 运维入口：`scripts/tasks/router.ts`、`scripts/deposit.ts`（示例）。
  - 不变量/常见问题：批处理的原子性与回滚；命令数组的语义约束；默认值陷阱与参数越界；外部依赖失败如何处理。

- Strategies（策略）
  - 是什么：对外协议的策略模块集合（Aave/Curve/Uniswap 等）。
  - 用途：管理资产在外部协议中的配置、收益与风险，支持收割与再平衡。
  - 哪里看：`contracts/core/strategies/`、`doc/core/strategies/`、`doc/interfaces/*`。
  - 运维入口：`scripts/tasks/strategy.ts`。
  - 不变量/常见问题：策略的资金边界与健康阈值；退出/失败路径；多策略之间的再平衡语义。

- Oracles（预言机：Pyth/ChainLink/Ratio/ExRate）
  - 是什么：价格、比率与汇率数据源。
  - 用途：报价与净值计算，防止旧数据或偏差影响决策。
  - 哪里看：`contracts/oracles/*`、`doc/oracles/*`。
  - 运维入口：`scripts/tasks/oracles.ts`、升级脚本 `scripts/upgrade-oracles.ts`。
  - 不变量/常见问题：新鲜度与偏差阈值；多源比对一致性；失败路径与默认值。

- VaultSettings（参数面板）
  - 是什么：统一管理费用、限额、阈值、白名单等运营参数。
  - 用途：对风险与运营做调优，限制异常输入或规模。
  - 哪里看：`contracts/core/VaultSettings.sol`、`doc/core/VaultSettings.md`。
  - 运维入口：`scripts/tasks/settings.ts`。
  - 不变量/常见问题：参数变更的权限与审批语义；事件证据；变更对状态机的影响。

- VaultRegistry（目录）
  - 是什么：产品地址注册与解析。
  - 用途：所有脚本与前端都能通过目录发现金库。
  - 哪里看：`contracts/core/VaultRegistry.sol`、`doc/core/VaultRegistry.md`。
  - 运维入口：`scripts/tasks/vault.ts`（或部署脚本）。
  - 不变量/常见问题：注册正确性与唯一性；更新事件与引用一致性。

- Proxy / BakerFiProxy + ProxyAdmin（可升级代理）
  - 是什么：把产品逻辑与地址固定分离，支持版本迭代与热修。
  - 用途：安全迭代业务逻辑，保持用户与前端/脚本地址不变。
  - 哪里看：`contracts/proxy/BakerFiProxy.sol`、`doc/proxy/BakerFiProxy.md`、`doc/proxy/BakerFiProxyAdmin.md`、`doc/storage-compatibility.md`。
  - 运维入口：`scripts/upgrade-*.ts`、`scripts/verify.ts`。
  - 不变量/常见问题：初始化流程；存储槽位兼容；升级权限；失败回滚与暂停策略。

- Libraries（库）
  - 是什么：数学与 DEX 辅助库。
  - 用途：统一实现细节，保证报价与计算的可复用与一致。
  - 哪里看：`contracts/libraries/*`、`doc/libraries/*`。
  - 不变量/常见问题：边界与精度；溢出与舍入；依赖外部路由的返回值语义。

---

## 3. 典型流程地图（从入口到证据）

- 存款（Deposit）
  - 路径：`scripts/deposit.ts` → `VaultRouter.deposit(...)` → `Vault.mint/...` → 事件 `Deposit`。
  - 关键概念：ERC-4626 资产-份额换算；费用与限额；余额变化与事件对账。

- 取款（Withdraw/Redeem）
  - 路径：`VaultRouter.withdraw/redeem` → `Vault.redeem/...` → 事件 `Withdraw`。
  - 关键概念：退出费；策略资产回流；滑点与失败路径。

- 收割与再平衡（Harvest/Rebalance）
  - 路径：`scripts/tasks/strategy.ts` → 策略操作 → `MultiStrategyVault` 归集与再分配 → 事件 `Harvest/Rebalance`。
  - 关键概念：时间窗与频率；归集账户；再平衡目标比例与容忍阈值。

- 预言机更新（Oracle Update）
  - 路径：`scripts/tasks/oracles.ts` / `scripts/upgrade-oracles.ts` → 合约配置更新 → 事件。
  - 关键概念：新鲜度与偏差；多源一致性；失败默认值。

- 参数变更（Settings Update）
  - 路径：`scripts/tasks/settings.ts` → `VaultSettings` 写入 → 事件。
  - 关键概念：权限矩阵与审批；参数对状态机的影响；对账与证据链。

- 代理升级（Proxy Upgrade）
  - 路径：`scripts/upgrade-*.ts` → `ProxyAdmin.upgrade` → 初始化/迁移 → 事件。
  - 关键概念：存储兼容；初始化安全；失败回滚；版本证据链（事件+校验）。

---

## 4. ATT&CK 式覆盖框架（适配智能合约审计）

说明：此框架旨在覆盖“几乎所有”常见风险面，按技术域组织，供审计清单与演练使用。

- 入口与信任边界（Entry & Trust Boundary）
  - 枚举所有 `external/public` 端点与 Router 命令；标注授权修饰器（白名单/角色/暂停/限额）。
  - 触达路径映射：前端/脚本 → ABI → 合约端点 → 事件回执。

- 授权与特权（Authorization & Privilege）
  - 高权限入口：升级、参数面板、策略管理、Router 命令白名单。
  - 角色矩阵：`Ownable/Governable/AccessControl/Pausable`；审批语义与事件证据。

- 参数语义与批处理（Parameter Semantics & Batch Processing）
  - 命令数组与复合结构的边界/默认值/禁配组合；回滚与原子性。
  - 外部返回值（AMM/预言机/借贷）验证与失败路径。

- 状态机与不变量（State Machine & Invariants）
  - 资金流对账：入/出事件、余额、费用的三表一致性。
  - 残余资产清扫；部分成功场景的中间态处理。

- 外部集成与市场风险（External Integration & Market Assumptions）
  - 预言机新鲜度/偏差阈值；多源对齐（Pyth/ChainLink）。
  - DEX 报价与滑点；借贷清算门槛与健康因子。

- 升级与存储（Upgrade & Storage Compatibility）
  - 代理与初始化：版本迁移步骤与失败回滚预案。
  - 槽位布局：新增变量、继承顺序、`EmptySlot` 预留；与 `doc/storage-compatibility.md` 对照。

- 资产特性与费用（Asset Characteristics & Fee Accounting）
  - 非标准 ERC-20、fee-on-transfer、rebasing、ERC-777 回调带来的会计与安全影响。
  - 费用扣取路径与归集账户，事件证据与对账。

此覆盖框架在“多策略金库/路由/预言机/可升级/参数运营”领域能覆盖约 80%+ 的常见审计面。

---

## 5. 覆盖度与边界说明

- 较少覆盖：跨链/桥接与消息证明、完整治理（Timelock/Governor/Vote）、NFT/拍卖、复杂经济博弈（如 MEV 细化与市场操纵）。
- 多链/L2 差异：Gas 经济、最终性/重放、系统合约交互等需额外检查清单。
- 做法：在本框架之上，按你项目的“外部协议/资产类型/目标链”增添专用检查项与微型 PoC。

---

## 6. 最小验证清单（动手 5 项）

- 路由批处理一致性
  - 用 `scripts/tasks/router.ts` 执行两步以上命令；观察事件与余额；验证失败路径是否回滚一致。
- 策略收割与再平衡
  - 用 `scripts/tasks/strategy.ts` 收割并再平衡；检查目标比例与容忍阈值；对账资产回流。
- 代理升级与存储兼容
  - 用 `scripts/upgrade-*.ts` 升级一次；比对事件与槽位；验证初始化与权限矩阵。
- 预言机新鲜度与偏差
  - 用 `scripts/tasks/oracles.ts` 更新配置；模拟旧数据与偏差；看保护阈值是否生效。
- 参数变更与权限证据
  - 用 `scripts/tasks/settings.ts` 改一项关键参数；核对事件与权限；观察对状态机影响。

---

## 7. 概念卡模板（用于你继续扩展）

```
概念名：
是什么（一句话）：
用来干什么（业务语义）：
在哪里看（代码/文档/脚本）：
运维入口（tasks/commands）：
不变量（必须成立）：
常见问题（易错点）：
最小验证（1-2 步）：
证据链（事件/回执/版本/槽位）：
```

---

## 8. 快速导航（代码 ↔ 文档 ↔ 脚本）

- 合约 ↔ 文档
  - `contracts/core/Vault.sol` ↔ `doc/core/Vault.md`
  - `contracts/core/MultiStrategyVault.sol`（若存在）↔ `doc/core/MultiStrategyVault.md`
  - `contracts/core/VaultRouter.sol` ↔ `doc/core/VaultRouter.md`
  - `contracts/core/MultiCommand.sol` ↔ `doc/core/MultiCommand.md`
  - `contracts/core/VaultSettings.sol` ↔ `doc/core/VaultSettings.md`
  - `contracts/core/VaultRegistry.sol` ↔ `doc/core/VaultRegistry.md`
  - `contracts/oracles/*` ↔ `doc/oracles/*`
  - `contracts/proxy/BakerFiProxy.sol` ↔ `doc/proxy/BakerFiProxy.md` / `doc/proxy/BakerFiProxyAdmin.md`
- 脚本入口
  - 部署：`scripts/deploy.ts`、`scripts/deploy-router.ts`、`scripts/deploy-multistrategy-dev.ts`
  - 参数：`scripts/tasks/settings.ts`、`scripts/tasks/router.ts`、`scripts/tasks/oracles.ts`
  - 策略：`scripts/tasks/strategy.ts`
  - 升级：`scripts/upgrade-*.ts`、`scripts/verify.ts`

---

## 9. 如何使用本框架

- 阅读顺序：第 1→2→3→4 节依次建立理解；第 6→7 节用于动手与记录。
- 交付物：用“概念卡模板”记录每个模块的不变量与证据；用“最小验证清单”形成 PoC。
- 扩展：把你项目特有的协议/资产/链加入第 4 节为子项，并关联脚本与测试。

如需，我可以再补一份“最小实验步骤卡”与“事件/余额对照表”，直接放到 `handbooks/` 供执行记录。