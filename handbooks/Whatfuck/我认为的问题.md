下一步 确实应该做“方法论 / 实例”分离，这一步一旦做完，你的三阶段体系就不只是 BakerFi 的项目文档，而是一个 可泛化、可复用的行动模板体系。
我来帮你明确这一步该怎么拆、为什么拆、拆完会得到什么。👇

🧭 一、核心目标：让方法论从项目中抽象出来
当前：
阶段 1 / 2 / 3 混合了两层信息：
方法论层：概念、结构、验证逻辑、标准映射（普适）
实例层：模块、命令、路径、日志（项目特定）
下一步：
将每个阶段拆分为
A. 方法论模板（Methodological Template）
B. 实例落地（Project Implementation）
这样：
A 部分可复制到任意项目；
B 部分随具体仓库而变；
两者之间通过 映射规则与索引表 自动衔接。
🧩 二、分离后各阶段的结构
阶段
方法论模板（A）
实例落地（B）
输出
阶段 1：系统认知与假设
定义四维体系（Structure / Authority / Value / Invariant）与 LATER 对齐规则
以当前仓库模块填充 Facts（模块边界、角色、依赖）
system_overview.md + bakerfi_system_overview.md
阶段 2：验证与证据
定义 Facts / Assertions / Evidence 的规范与目录结构
运行实际命令、收集输出、填入表格
method_stage2_template.md+ audits/stage2/*
阶段 3：聚合与映射
定义 LATER × Standard × Tool 三元映射逻辑与报告字段
填充 BakerFi 的问题卡片、报告、验证日志
method_stage3_template.md+ audits/stage3/*


🧱 三、设计原则（核心理念）
方法论文档永远不含路径与命令。
它只定义“该做什么”和“产物结构”，不含项目名与目录。
例：run slither → 改写为 “执行静态分析工具并归档输出”。
实例文档只包含路径与具体命令。
例：npx hardhat test test/core/vault/* 这类内容留在实例层。
二者通过映射表绑定。
比如：
| Method ID | Project Path | Command | Evidence |
|------------|--------------|----------|-----------|
| method.stage2.static-analysis | slither.config.json | slither . --config-file slither.config.json | audits/stage2/slither/vault.json |


方法论中保留抽象语法与 schema
例如：
Stage2 Schema: {facts, assertions, evidence}
Stage3 Schema: {id, layer, standard, tool, evidence}

⚙️ 四、分离后的直接好处
维度
分离前（混合）
分离后（模板化）
可复用性
只能在 BakerFi 内使用
可直接迁移到下一个项目
维护成本
改一次都要改全
模板稳定、实例局部更新
自动化潜力
结构不稳定，难脚本化
可以 YAML/JSON 化，一键生成报告
审计一致性
各项目风格不同
统一格式，可聚合横向对比
培训/交接
需手把手说明
方法论文档即“行动手册”


🧩 五、下一步行动建议（可直接执行）
1️⃣ 建立三份模板文档
在 audits/methodology/ 下创建：
stage1_methodology.md
stage2_methodology.md
stage3_methodology.md
2️⃣ 把你现有阶段文档分离：
从现有文本中抽离所有“普适定义 / 结构 / 验收标准 / 模板表格”到 methodology；
保留“BakerFi 专属命令 / 模块 / 文件路径 / 具体断言”在 audits/bakerfi_stageX.md。
3️⃣ 建立映射索引文件：
audits/index.yaml
project: bakerfi
stages:
  - stage: 1
    template: audits/methodology/stage1_methodology.md
    instance: audits/bakerfi_stage1.md
  - stage: 2
    template: audits/methodology/stage2_methodology.md
    instance: audits/bakerfi_stage2.md
  - stage: 3
    template: audits/methodology/stage3_methodology.md
    instance: audits/bakerfi_stage3.md

4️⃣ 长期优化方向：
后续可自动生成实例文档的骨架：
python generate_stage_docs.py --template audits/methodology/stage2_methodology.md --output audits/new_project_stage2.md


🧠 六、总结性判断
✅ 你现在的理解完全正确：
下一步要做的确实是 将阶段 1–3 拆分为“方法论模板 + 实例落地”两层。
✅ 一旦分离，你就拥有一个真正的「普适行动模板体系」：
可以独立存在、跨项目使用；
每次新项目只需填“实例层”；
方法论部分保持不变，成为通用审计框架的核心资产。
一句话总结：
你正在从“项目文档”升级为“体系文档”。
这一步一旦完成，你的三阶段体系就不再是 BakerFi 的特例，而是一个可以标准化、复用、培训、外包、甚至出版的完整安全方法论。


---

## 结论与约束（不新增结构）

- 结论：采纳“方法论 / 实例”分离思路，但遵循当前冻结约束，不新增目录或文件，不改动现有三阶段文档结构。分离以“文内标记 + 统一编号 + 索引登记”的方式在现有文件夹内落地。
- 承诺：仅在现有文档中补充模板段落与执行清单，并在 `audits/stage2/*` 现有归档内完成证据登记。暂不创建 `audits/methodology/*`、`audits/index.yaml` 等新产物。

## 轻量落地方案（沿用现有结构实现分离）

- 方法论与实例的文内标记：沿用阶段2文档中已存在的“三层”结构（方法论层 / 框架模板层 / 实例层），将其视为 Methodology / Template / Instance 的语义分层，无需新增文件。
- 统一编号：沿用 `BF-{module}-s2-{later}-{topic}-{index}` 作为唯一主键；阶段3继续复用该主键。
- 索引登记位置：在 `audits/stage2/stage2_index.md` 内维护两张表（标准映射记录、阶段2→阶段3衔接表），用于阶段3的聚合入口；不新增新的索引文件。
- 证据归档：使用现有 `audits/stage2/evidence/*` 目录，分类命名建议：Tests=`BF-*-test.log`，Static=`BF-*-slither.json`，Graphs=`BF-*-graph.dot|png`，Invariants=`BF-*-invariant.log`，Runtime=`BF-*-runtime.log`。

## 执行清单（建议一次跑通）

1) 运行测试：`npx hardhat test`
2) 覆盖率：`npx hardhat coverage`
3) Gas 报告（若已集成）：`npm run test:gas`
4) 静态分析：`slither . --config-file slither.config.json`
5) （可选）调用图：`surya graph contracts/core/Vault.sol --output audits/stage2/graphs/vault.dot`
6) （可选）不变量：`echidna-test . --config echidna.yaml`

## 最小里程碑（现有模块，1–2条登记）

- vault：登记资产守恒与 `pricePerShare` 单调的 BF 条目，归档测试/覆盖率/静态分析证据。
- proxy：登记 `initialize()` 一次性与槽位兼容的 BF 条目，补充选择器/版本标签与升级日志证据（参考 `scripts/upgrade-*.ts`）。
- oracles：登记新鲜度/单位精度的 BF 条目，归档异常边界触发与事件对照证据。

## 注意与风险（记录在案）

- 单位与容差：数值断言需明确单位与 `epsilon` 范围（在阶段2条目内说明）。
- 覆盖率阈值：核心路径建议 ≥70%（为建议线，不是强制线）。
- Authority vs Trust：外部依赖（预言机/第三方协议/管理员密钥）需分开登记“权限”与“信任来源”，对应阶段3的 T/E 标签。

## 不做事项（保持冻结）

- 不创建 `audits/methodology/*`、`audits/index.yaml`、生成脚本等新文件。
- 不改动阶段1/2/3文档的结构与标题，仅补充内容与索引表格。
- 不新建报告或卡片目录（阶段3聚合时再使用既有结构输出）。

## 下一步动作（即刻执行）

- 在 `audits/stage2/stage2_index.md` 增补两张表：
  - 标准映射记录表：`module | dimension | LATER | SWC | SCSVS | risk | description | notes`
  - 阶段2→阶段3衔接表：`BF ID | Module | LATER | Standard | Evidence | Notes`
- 为 `vault/proxy/oracles` 各登记 1–2 条 BF 条目，补充命令与证据路径（测试/覆盖率/静态分析/可选图谱）。
- 归档产出到 `audits/stage2/evidence/*`，并在阶段2文档相应条目内填写“verified by …”命令与路径。


---

## 判断与执行方案（不新增结构）

- 判断结论：方法论/实例分离的方向是正确且必要；为遵守此前“冻结”约束（不新增目录、文件、章节），我们将采用“轻量分离”的落地方式——在既有阶段文档内维持方法论段落，在现有 `audits/stage2/*` 目录下填充实例产物与索引，不创建 `audits/methodology/` 与 `audits/index.yaml`。
- 原则：不改结构、不加新文件；仅补充现有文档与索引的内容，直接可执行、可复验、可聚合。

### 落地动作（对应阶段1/2/3）
- 阶段1（认知基线）：
  - 不变更结构；阶段1继续作为四维体系与 LATER 映射的语义源头。
  - “概念不变量”仅作为语义声明，其数值与阈值在阶段2具体化。
- 阶段2（模板与实例）：
  - 在 `audits/stage2/stage2_index.md` 中按“阶段2总览索引模板”维护模块条目（`vault/proxy/oracles` 起步），填 `Facts/Assertions/Evidence/Status` 四列。
  - 在 `audits/stage2/trust_sources.md` 登记外部依赖与信任来源（Chainlink/Pyth/Ratio、Aave/Curve/Balancer/Lido/Uniswap 等），区分 Authority 与 Trust。
  - 在 `audits/stage2/run_test.md` 汇总统一执行入口与命令（`npx hardhat test`、`coverage`、`slither`），指向证据归档路径。
  - BF 编号沿用：`BF-{module}-s2-{later}-{topic}-{index}`，阶段3继续使用同一主键进行聚合。
- 阶段3（聚合与报告）：
  - 不新增章节；以阶段2的 BF ID + 标准标签 + 证据路径生成问题卡片与聚合映射，待阶段2条目完善后再行填充。

### 执行序（最小闭环）
- Step 1：为 `vault/proxy/oracles` 各登记 1–2 条 BF 条目（示例：`BF-vault-s2-A-asset-001`, `BF-proxy-s2-R-upgrade-001`, `BF-oracles-s2-E-freshness-001`），在阶段2文档填入 Facts/Assertions/Evidence。
- Step 2：运行基础命令并归档证据：
  - `npx hardhat test`（测试日志 → `audits/stage2/evidence/tests/*`）
  - `npx hardhat coverage`（覆盖率 → `coverage/`）
  - `slither . --config-file slither.config.json`（静态分析 → `audits/stage2/slither/*.json`）
- Step 3：在 `audits/stage2/stage2_index.md` 用表格登记各模块产物路径与状态（Done/Partial/Pending）。
- Step 4（可选）：导出调用图/权限矩阵（Surya），或记录升级证据链（参考 `scripts/upgrade-*.ts`）。

### 验收标准（本轮工作）
- 不新增任何目录/文件/章节，仅补充既有文档内容与索引记录。
- `stage2_index.md` 至少包含 `vault/proxy/oracles` 的 3 个条目，且每条有命令与证据路径。
- 登记 ≥3 个 BF ID，并在阶段2文档写明 Facts/Assertions/Evidence 的来源与复验命令。

### 风险与注意事项
- 单位与容差：数值断言（如 `epsilon`、`pricePerShare` 单调）在阶段2中需明确单位与容差；阶段1保持语义级描述即可。
- Authority vs Trust：权限与信任边界分开登记；管理员密钥与预言机来源分别记录，避免混淆维度。
- 误报与说明：Slither 的告警需在证据旁注明“误报/可接受风险”的理由，确保后续聚合清晰。

### 下一步动作（即刻执行）
- 我将按以上执行序，先在 `audits/stage2/stage2_index.md` 与 `audits/stage2/trust_sources.md` 补齐最小条目与登记表，并在阶段2文档中填入 3 个 BF 条目的 Facts/Assertions/Evidence 占位与命令。

