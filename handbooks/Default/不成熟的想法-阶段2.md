# 阶段2：方法论 + 模板 + 实例（结构/权限/资金流/不变量）

定位：将阶段2提升为「方法论（抽象）→ 框架模板（可移植）→ 实例映射（仓库落地）」三层结构，既可泛化到任意项目，又与当前仓库保持可执行的落地路径。

## 方法论层（抽象）：四维体系与验证映射

目标：建立可验证的系统模型，使每个模块在工具层面可追踪其结构、权限、价值流与不变量。

- 四维体系（模型视角）
  - Structure（结构）：模块边界、职责划分、依赖关系 → 结构一致性、外部调用控制
  - Authority（权限）：角色与操作绑定、信任假设 → 权限最小化、防止越权调用
  - Value Flow（价值流）：资产/代币流向、入口出口、停留点 → 资金守恒与流动一致性
  - Invariants（不变量）：系统应长期保持的数理关系 → 可验证的不变式与经济安全性

- 验证维度 × 工具映射
  - Static（静态）：Slither / Surya / Semgrep → 结构图、权限矩阵、模式匹配报告（结构性风险）
  - Dynamic（动态）：Hardhat / Foundry Tests → 行为日志、事件、余额变化（路径复现与验证）
  - Symbolic（符号）：Mythril / Manticore → 关键路径可达性报告（漏洞可达性）
  - Economic（经济）：Echidna / Custom Harness → 不变量验证、经济约束（守恒与单调）
  - Operational（运维）：Scripts / Runbook → 升级与回滚日志（生命周期验证）

- 输出规范（抽象归档）
  - 事实（Facts）：`system_structure.md`（模块边界、外部依赖）
  - 断言（Assertions）：`assertions.json`（模块断言与约束）
  - 证据（Evidence）：`audits/stage2/evidence/*`（日志、事件、覆盖率等）
  - 映射（Mapping）：`standard_mapping.csv`（SWC/SCSVS 风险编号对照）
  - 工具配置（Configs）：`*.yaml` / `*.json`（如 slither/echidna 配置文件）

- 命名与溯源规范
  - ID 模板：`{project?}-{module?}-{dimension}-{topic}-{index}`
  - 示例：`structure-dependency-001`, `authority-access-002`
  - 要求：阶段2与阶段3的 ID 可聚合与统一编号。

- 验收标准（通用）
  - 四维（Structure / Authority / Value / Invariant）各至少一份验证产物。
  - 每个产物都有来源（测试或工具）与可复验命令。
  - 行为路径、资金流、权限调用均获得覆盖与证据。
  - 所有事实、断言、证据均归档且具唯一编号。

- 输出关系图
  - 阶段1 → 系统认知（模型与假设）
  - 阶段2 → 可验证模型（结构/权限/资金流/不变量）
  - 阶段3 → 宏观映射与证据聚合（LATER × Standard × Tool）

## 框架模板层（可移植）：目录与命令模板

- 目录/文件组织（建议模板）
  - `audits/stage2/system_structure.md`（结构事实）
  - `audits/stage2/standard_mapping.csv`（标准映射）
  - `audits/stage2/run_test.md`（统一执行入口与命令）
  - `audits/stage2/evidence/`（各类日志/截图/JSON 输出）
  - `audits/stage2/slither/`, `audits/stage2/graphs/`, `audits/stage2/mythril/`, `audits/stage2/invariants/`, `audits/stage2/gas/`, `audits/stage2/findings/`

- 工具与配置模板（占位与可替换）
  - Static：`slither . --config-file slither.config.json`
  - Dynamic：`npx hardhat test`；`npx hardhat coverage`
  - Visualization（可选）：`surya graph <contract> --output audits/stage2/graphs/<name>.dot`
  - Symbolic（可选）：`myth analyze <contract> -o json -t 300`
  - Invariants（可选）：`echidna-test . --config echidna.yaml`

- 通用命令模板（占位符）
  - 测试入口：`npx hardhat test <path/to/tests>`
  - 覆盖率：`npx hardhat coverage`
  - Gas 报告：`npm run test:gas`（如集成 `hardhat-gas-reporter`）
  - 静态分析：`slither <path|.> --config-file slither.config.json`
  - 图谱：`surya graph <contract> --output audits/stage2/graphs/<module>.dot`

---

## 实例层（当前仓库映射）：BakerFi 落地

目标：从“阶段3”的三元映射（层视角 × 标准编号 × 工具证据）倒推到可直接执行的基础落地清单，使审计在当前项目里既合理抽象，又高度实践，形成可复验的事实基础与证据素材，为阶段3的聚合与报告做铺垫。

## 核心输出（阶段2）
- 最小事实集：结构边界、资金流守恒、权限矩阵、初始化与升级幂等、关键事件与余额一致性。
- 可复验证据：测试与覆盖率、Slither 静态分析输出、（可选）Surya 图谱、Gas 报告。
- 模块断言集：对 Vault/Router/MultiStrategy/MultiCommand/Oracles/Proxy 的关键断言与复现命令。
- 归档目录：`audits/stage2/*`（findings/evidence），命名与编号与阶段3兼容。

## 工具与命令（必选/可选）
- 必选
  - 测试：`npx hardhat test`
  - 覆盖率：`npx hardhat coverage` 或 `npm run test:coverage`
  - Gas 观测：`npm run test:gas`（项目已集成 `hardhat-gas-reporter`）
  - 静态分析：`slither . --config-file slither.config.json`
- 可选（若未安装则跳过，不阻塞阶段2）
  - 调用图/权限矩阵（Surya）：`surya graph <contract> --output audits/stage2/graphs/*.dot`
  - 符号执行（Mythril）：`myth analyze <contract> -o json -t 300`
  - 不变量（Echidna）：`echidna-test . --config echidna.yaml`（当前仓库有 `echidna.yaml`，但不变式合约需按需补充）

## 通用检查清单（动词导向）
- 枚举结构：明确模块边界与外部依赖（Vault/Router/Proxy/Oracles/Strategies）。
- 走查权限：梳理 `Ownable/AccessControl`、初始化/暂停/升级权限与执行通道；输出权限矩阵（Slither/Surya 可选）。
- 验证资金流：`deposit/withdraw/rebalance` 事件与余额一致，`totalAssets/pricePerShare` 单调与非负。
- 校验批处理：MultiCommand/MultiStrategy 的批处理“全成/全败”语义与边界回滚。
- 检查预言机：价格来源、更新频率与单位精度；极值/延迟保护是否可触发。
- 审核升级：代理槽位与选择器比对、初始化一次性、版本标签与回滚流程（参考 `scripts/upgrade-*.ts`）。

## 模块落地（最小命令 × 关键断言 × 证据）
- Vault（`contracts/core/Vault.sol`）
  - 最小命令：`npx hardhat test test/core/vault/*`；`npx hardhat coverage`
  - 关键断言：`totalAssets/pricePerShare` 单调；`deposit/withdraw` 事件与余额一致；费用与会计口径正确。
  - 证据：测试通过截图或日志、覆盖率行号、事件/余额对照片段。
- VaultRouter（`contracts/core/VaultRouter.sol`）
  - 最小命令：`npx hardhat test test/core/vault/*`
  - 关键断言：输入校验与授权；跨模块调用的金额与事件一致；边界值触发回滚。
  - 证据：失败/回滚案例、事件序列、（可选）Surya 调用图。
- MultiStrategy（`contracts/core/MultiStrategy.sol`）
  - 最小命令：`npx hardhat test test/core/strategies/*`
  - 关键断言：策略分配与总资产守恒；再平衡前后事件与余额一致；异常路径回滚。
  - 证据：再平衡交易日志、资产差异对照、覆盖率片段。
- MultiCommand（`contracts/core/MultiCommand.sol`）
  - 最小命令：`npx hardhat test test/hooks/*`
  - 关键断言：批处理原子性（全成/全败）；事件顺序与最终余额一致。
  - 证据：批处理成功与失败两类日志、余额终态。
- Oracles（`contracts/oracles/*`）
  - 最小命令：`npx hardhat test test/oracles/*`
  - 关键断言：极值/延迟/单位精度；价格缓存与新鲜度；异常输入回滚。
  - 证据：边界触发案例、事件与单位一致性对照。
- Proxy（`contracts/proxy/BakerFiProxy.sol`）
  - 最小命令：`npx hardhat test test/proxy/*`；参考 `scripts/upgrade-*.ts`
  - 关键断言：初始化仅一次；槽位兼容（存储布局不破坏）；选择器与版本一致；升级/回滚证据链。
  - 证据：槽位 Diff、选择器比对、升级交易日志与版本标签。

## 不变量模板（阶段2可用的 Hardhat 断言或待补 Echidna Harness）
- 资产守恒：对任意序列 `deposit/withdraw/rebalance`，总资产不负且不出现凭空增减；账面份额变化与资产变动相符。
- 批处理原子性：批处理执行要么全部成功，要么整体回滚；部分成功视为失败。
- 初始化与升级：`initialize()` 只能成功一次；升级不改变关键槽位；升级后版本标签与选择器集合满足预期。

注：若引入 Echidna，不变量可迁移为 Harness 合约；阶段2先以 Hardhat 断言确保行为约束。

## 证据归档与命名（与阶段3兼容）
- 归档目录建议：
  - 报告与卡片：`audits/stage2/findings/{id}.md` 与 `{id}.json`
  - 覆盖率报告：`coverage/`（硬盘路径保留即可）
  - 静态分析：`audits/stage2/slither/{module}.json`
  - 调用图（可选）：`audits/stage2/graphs/{module}.dot|.png`
  - Gas 报告：`audits/stage2/gas/{date}.md`
- 命名建议：`BF-{module}-stage2-{topic}-{index}`（例如：`BF-vault-stage2-asset-001`），可与阶段3编号并存。

### 命名与编号统一（方法论层）
- 通用 ID 模板：`{project?}-{module?}-{dimension}-{topic}-{index}`
- 维度枚举：`structure | authority | value | invariant | oracle | upgrade | batch`（与阶段3 LATER 对齐）
- 示例：`bkr-vault-structure-boundary-001`, `bkr-proxy-upgrade-slot-002`
- 规则：
  - `module` 取仓库内模块名或角色名（如 `vault`, `router`, `proxy`, `oracle`）。
  - `topic` 避免过长，聚焦一个问题点（如 `boundary`, `slot`, `atomicity`）。
  - `index` 递增编号，保持稳定映射，便于阶段3聚合。

### 输出类型汇总（方法论层）
- Facts：结构事实与依赖说明（`system_structure.md`）
- Assertions：行为与约束断言（`assertions.json` 或测试断言片段）
- Evidence：工具输出与日志（`audits/stage2/evidence/*`）
- Mapping：标准编号映射（`standard_mapping.csv`）
- Coverage：覆盖率报告（`coverage/`）
- Graphs：结构与调用图（`audits/stage2/graphs/*`）
- Static Analysis：Slither 报告（`audits/stage2/slither/*.json`）
- Invariants：Echidna 或 Hardhat 不变量（`audits/stage2/invariants/*`）

### 统一验收标准（方法论层）
- 每个维度至少一条可复验产物（含命令与路径）。
- 关键路径测试通过且具备覆盖率证据。
- 权限矩阵导出并审阅关键函数受控性。
- 不变量至少以测试断言或 Harness 形式存在并归档。
- 所有产物具备统一命名与编号，能在阶段3聚合。

## 验收标准（阶段2完成线）
- 测试通过：核心模块测试均通过，关键断言无失败。
- 覆盖率：核心路径（Vault/Proxy/Oracles/Router）行覆盖率达到可接受阈值（建议 ≥70%）。
- 静态分析：完成一次 Slither 全项目扫描，记录重要警示并对照处理（误报注明原因）。
- 权限矩阵：至少输出一次权限关系（Slither/Surya），确认关键函数受控。
- 证据归档：上述证据均有归档记录，文件名与编号一致，便于复验。

## 执行序列（建议按此顺序跑一遍）
1) `npx hardhat test`
2) `npx hardhat coverage` 或 `npm run test:coverage`
3) `npm run test:gas`
4) `slither . --config-file slither.config.json`
5) （可选）`surya graph contracts/core/Vault.sol --output audits/stage2/graphs/vault.dot`
6) （可选）`echidna-test . --config echidna.yaml`（若已补充不变式 Harness）

## 与阶段3的衔接
- 阶段2产出的事实与证据，会被阶段3绑定到三元映射：
  - 层视角（L-A-T-E-R）：结构/资产/权限/预言机/批处理/代理。
  - 标准编号（SWC/SCSVS/DASP）：作为标签与编号统一归档。
  - 工具证据（测试/覆盖/静态/图谱/不变量/Gas）：形成复现命令与文件路径。
- 当阶段2验收完成后，即可在阶段3中生成问题卡片、聚合映射与修复闭环报告。

### 四维到 LATER 映射（方法论层）
- 目的：将阶段2的四维（Structure/Authority/Value/Invariants）稳定映射到阶段3的 LATER 维度，避免中间语义转换。
- 定义（建议）：
  - L = Layer / Structure（结构层）：模块边界、依赖与一致性。
  - A = Asset / Value（资产与价值流）：资金入口/出口/停留点与守恒。
  - T = Trust / Authority（信任与权限）：角色最小化、越权与治理约束。
  - E = External / Oracle（外部与预言机）：外部依赖、预言机新鲜度与偏差。
  - R = Routine / Runtime（批处理与运维）：批处理原子性、升级与回滚流程。
- 映射关系：
  - Structure → L；Value → A；Authority → T；Invariants（经济/安全不变式）→ A/T/L（按具体归属标注）；Oracles → E；Proxy/Router/Batch → R。

#### 语义边界与判定准则
- Structure vs Invariant：若断言涉及行为约束（运行时关系、经济条件），优先归入 Invariants；若仅描述布局/依赖/选择器集合一致性，归入 Structure。
- Authority vs Trust：Authority 记录“谁可调用”；Trust 记录“对外部组件的信任来源与验证”（如预言机数据源、管理员密钥托管）。阶段2输出需分别标注。

#### 用语规范（Facts / Assertions / Evidence）
- Facts：使用第三人称客观陈述（is/has/depends on）。例如：“Vault has invested assets through Strategies.”
- Assertions：使用情态动词（must/should/shall not）。例如：“totalAssets must equal sum(strategyAssets) at all times.”
- Evidence：使用“verified by …”并给出命令与路径。例如：“verified by `npx hardhat test`, logs at audits/stage2/evidence/vault/asset_001.log”。

### BF 统一编号规范（阶段2 ↔ 阶段3）
- 格式：`BF-{module}-{stage}-{later}-{topic}-{index}`（例如：`BF-vault-s2-A-asset-001`）
- 字段说明：
  - `module`：仓库模块名（vault/router/proxy/oracle/...）。
  - `stage`：阶段标识（s2/s3）。
  - `later`：L|A|T|E|R 五选一（必要时可用两位并列，如 `AT`）。
  - `topic`：问题主题的简短词（boundary/slot/atomicity/freshness/...）。
  - `index`：递增序号，稳定不变，用于索引与证据聚合。
- 约束：
  - 所有产物（Facts/Assertions/Evidence/Mapping）均带可解析 ID；
  - 第三阶段的聚合与卡片生成以该 ID 为主键；
  - 建议在 `audits/stage2/stage2_to_stage3_index.md` 中登记 ID 与证据路径。

### 模块记录模板（Facts / Assertions / Evidence）
- 目的：统一记录格式，让阶段2产出直接可被阶段3聚合。
- 模板（示例，写入各模块事实或断言时参考）：

```
ID: BF-vault-s2-A-asset-001
Module: vault
LATER: A
Dimension: value
Topic: asset_conservation
Standard: SWC-107; SCSVS-Asset-Accounting
Fact:
  - Vault 总资产定义：totalAssets = sum(held + invested)
  - 资金流入口：deposit；出口：withdraw；再平衡：rebalance
Assertion:
  - 对任意序列 deposit/withdraw/rebalance，资产不负且守恒
Evidence:
  - Test: npx hardhat test test/core/vault/*
  - Coverage: coverage/index.html 行区间 <links>
  - Static: audits/stage2/slither/vault.json
  - RunLog: audits/stage2/evidence/vault/asset_001.log
```



## 结构建模与标准映射（实例层补充）

- 结构建模输出（承接阶段1）：
  - Vault（`contracts/core/Vault.sol`）：金库会计、发行份额；是否持币：是；可升级：是；外部依赖：策略/路由。
  - Router（`contracts/core/VaultRouter.sol`）：批量调用与入口控制；是否持币：否；可升级：否；外部依赖：Vault/Strategies。
  - Strategies（`contracts/core/strategies/*`）：策略资金管理与再平衡；是否持币：是；可升级：按实现；外部依赖：外部协议。
  - Proxy（`contracts/proxy/*.sol`）：升级与治理；是否持币：否；可升级：是；外部依赖：Admin/实现合约。
  - Oracles（`contracts/oracles/*`）：价格与预言机；是否持币：否；可升级：按实现；外部依赖：链上预言机。

- 行业标准映射表（为阶段3标签准备）：
  - Vault：潜在风险点=重入/资金错记；SWC=`SWC-107`；SCSVS=`SCSVS-Asset-Accounting`；说明：确认 `totalAssets` 与份额守恒。
  - Router：潜在风险点=调用顺序错误；SWC=`SWC-128`；SCSVS=`SCSVS-Atomicity`；说明：全成/全败语义。
  - Proxy：潜在风险点=升级风险；SWC=`SWC-112`；SCSVS=`SCSVS-Upgrade-Safety`；说明：初始化幂等与存储兼容。
  - Oracles：潜在风险点=价格操纵/延迟；SWC=`SWC-116`；SCSVS=`SCSVS-Oracle-Freshness`；说明：新鲜度与偏差控制。
  - Registry/Settings（如有）：潜在风险点=权限集中；SWC=`SWC-124`；SCSVS=`SCSVS-AccessControl`；说明：角色最小化。

---

### 标准映射记录格式（文档内模板）
- 目标：在阶段2文档中直接维护标准映射上下文，以支持阶段3聚合。
- Markdown 表格模板：

| module | dimension | LATER | SWC | SCSVS | risk | description | notes |
|--------|-----------|-------|-----|-------|------|-------------|-------|
| vault  | value     | A     | 107 | Asset-Accounting | medium | 资产会计/守恒 | 确认 totalAssets 与份额守恒 |

- 可选 JSON Schema（仅作格式参考，不强制生成文件）：
`{ module, dimension, LATER, standards: { SWC, SCSVS }, risk, description, notes }`

### 证据分类规范（文档内约定）
- 分类：
  - Tests：测试日志与截图；建议命名 `BF-*-test.log`。
  - Static：静态分析输出；建议命名 `BF-*-slither.json`。
  - Invariants：不变量验证日志；建议命名 `BF-*-invariant.log`。
  - Runtime：部署/升级/回滚日志；建议命名 `BF-*-runtime.log`。
- 命名：统一前缀使用 BF ID（`BF-{module}-s2-{later}-{topic}-{index}`）。
- 归档：在阶段2执行时统一记录证据路径并在文档条目内注明复验命令。

### 不变量表达语法（统一表达）
- 使用半结构表达：`assert(<boolean-expression>)`。
- 示例：
  - `assert(totalAssets >= 0)`
  - `assert(totalAssets == sum(strategyAssets))`
  - `assert(abs(priceDelta) <= epsilon)`，并在条目内注明单位与 `epsilon`。
- 辅助函数名需在 Facts 中说明其语义（如 `sum(strategyAssets)`）。

### 阶段2总览索引模板（文档内维护）
- 用途：集中展示模块产物路径与完成状态，供阶段3与人工复核。
- 表格模板：

| Module | LATER | SWC | SCSVS | Facts | Assertions | Evidence | Status |
|--------|-------|-----|-------|-------|------------|----------|--------|
| vault  | A     | 107 | Asset-Accounting | audits/stage2/vault/facts.md | audits/stage2/vault/assertions.md | audits/stage2/vault/evidence/ | ✅ Done |

### 阶段2 → 阶段3衔接表模板（文档内维护）
- 字段：BF ID、Module、LATER、Standard(SWC/SCSVS/DASP)、Evidence（命令与路径）、备注。
- 示例：

| BF ID | Module | LATER | Standard | Evidence | Notes |
|-------|--------|-------|----------|----------|-------|
| BF-vault-s2-A-asset-001 | vault | A | SWC-107 / SCSVS-Asset-Accounting | `npx hardhat test`；coverage link；slither/vault.json | 资产守恒与份额一致性 |

### 模块模板最小集（文档内示例）
- Facts（is/has/depends on）：
  - Vault has invested and held assets via Strategies.
  - Vault depends on Router for user entry operations.
- Assertions（must/should/shall not）：
  - totalAssets must equal sum(strategyAssets) under accounting definition.
  - pricePerShare must be monotonic except fees or realized loss events.
- Evidence（verified by）：
  - verified by `npx hardhat test`; logs at `audits/stage2/evidence/tests/BF-vault-s2-A-asset-001-test.log`
  - coverage at `coverage/index.html#L100-L180`

---

### System Model Schema（可转译模型）
- 目的：将四维模型抽象为“系统安全语言”，可被工具与阶段3直接解析与聚合。
- 模板（YAML/JSON 皆可，示例以 YAML 展示）：
```
module: vault
inputs: [deposit, rebalance]
outputs: [withdraw]
state_vars: [totalAssets, totalShares]
dependencies:
  - strategies[]
  - oracle
invariants:
  - name: AssetsNonNegative
    expr: assert(totalAssets >= 0)
  - name: AssetsConservation
    expr: assert(totalAssets == sum(strategyAssets))
assertions:
  - name: OnlyRouterDeposit
    expr: must(caller == VaultRouter)
value_flow:
  - source: user
    action: deposit(amount)
    sink: vault.totalAssets += amount
  - source: vault
    action: rebalance()
    sink: strategies[i].assets change
```
- 约束：
  - `state_vars` 与 `dependencies` 来自 Facts；
  - `invariants` 与 `assertions` 用半结构表达（参见“不变量表达语法”章节）；
  - `value_flow` 用最小三元组（source/action/sink）描述资金路径；
  - 建议统一维护在阶段2文档的模块小节或专章，以便阶段3聚合。

### 验证接口抽象（工具可替换的统一接口）
- 目的：降低工具耦合度，以抽象接口描述验证角色，具体实现可替换。
- 接口层设计：
  - `StaticAnalyzer` → Slither / Semgrep / Surya
  - `DynamicTester` → Hardhat / Foundry
  - `InvariantVerifier` → Echidna / Custom Harness / Foundry Invariants
  - `SymbolicEngine` → Mythril / Manticore / z3 harness
  - `OperationalRunner` → Scripts / Runbook
- 配置建议（tools.yaml 示例骨架）：
```
static_analyzer:
  impl: slither
  config: slither.config.json
dynamic_tester:
  impl: hardhat
  scripts:
    - npx hardhat test
    - npx hardhat coverage
invariant_verifier:
  impl: echidna
  config: echidna.yaml
symbolic_engine:
  impl: mythril
  args: ["--solc-json", "./solc.json"]
operational_runner:
  scripts:
    - npm run upgrade:dry
    - npm run verify:proxy
```
- 约束：
  - 每个接口需给出“最小复现命令”与“产物路径约定”；
  - 更换实现时，仅需修改 `impl` 与参数，不影响验收与聚合流程。

### 经济不变量扩展（新增）
- 目的：补齐经济安全类断言，以覆盖奖励分配、滑点/折价、流动性与费用增长等场景。
- 示例表达（半结构）：
  - 奖励分配比例恒等：`assert(rewardToVault == rewardTotal * vaultShareRatio)`
  - Rebalance 收益非负：`assert(rebalanceProfit >= 0)`
  - 流动性比率阈值：`assert(liquidityRatio > threshold)`
  - 费用增长一致性：`assert(feeGrowth' >= feeGrowth)`
- 语义提示：
  - `vaultShareRatio` 与 `liquidityRatio` 的定义与单位需在 Facts 中给出；
  - `rebalanceProfit` 的计算口径应与会计定义一致，并说明异常情形（如强制平仓的损失）；
  - 阈值 `threshold` 与容差 `epsilon` 应有来源（配置或常量），避免歧义。

### 统一验收标准补充
- 模型：至少提供 1 份 `System Model Schema`，覆盖 `state_vars/inputs/outputs/dependencies/invariants/value_flow`。
- 接口：提供 `tools.yaml` 或等效接口描述，说明各验证角色的实现与最小复现命令。