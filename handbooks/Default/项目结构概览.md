# 项目结构概览（精简版）

# 目录清单
- `contracts/`  合约源码
- `test/` 常规测试和漏洞验证测试
- `scripts/` 部署
- `doc/` 文档
- `audits/stage2/` 自定义文件夹，过程性文件，私人文件夹。
- `handbooks/` 自定义文件夹，方法论与流程手册
- `src/` 类型与工厂
- `constants/` 常量与选择器
- 根文件与配置：`hardhat.config.ts`、`package.json`、`slither.config.json`、`echidna.yaml`、`tsconfig.json`


# 目录结构
* audits 自定义文件夹，过程文件
* handbooks 自定义文件夹，过程文件
* src 编译构建产物，不承载核心业务逻辑
* contracts 合约源码，业务逻辑目录
* 下一个是 doc 目录

### 🧱 `scripts` 目录说明
没写呢

### 🧱 `doc` 目录说明
* core 基本是自动生成的“Solidity API”文档，不是人工逐篇撰写。生成来源是 hardhat-docgen / solidity-docgen 插件，脚本为 npm run doc （即 npx hardhat docgen ）。文档内容来自合约的 ABI/AST 与 NatSpec 注释，随源码变化而更新。
* interfaces 文档是自动生成的，不是人工一篇篇写的。生成来源是文档生成插件（如 solidity-docgen / hardhat-docgen ），项目里有 npm run doc 来生成。面向接口的“Solidity API 参考手册”，把 contracts/interfaces/* 下的接口按目录结构导出为 Markdown。
* libraries 这一批 Markdown 是自动生成的，不是人工逐篇写的。项目使用文档生成插件（ solidity-docgen / hardhat-docgen ），通过 npm run doc （即 npx hardhat docgen ）把 contracts/libraries/* 的库导出为“Solidity API”参考文档。面向库函数的“Solidity API 参考”，为各类工具库提供函数签名、 struct 、常量等的统一文档。
* oracles - 这批 Markdown 文档是自动生成的，不是人工逐篇写的。 项目通过文档生成脚本（ npm run doc ，即 npx hardhat docgen ）把与预言机相关的合约/接口导出为“Solidity API”参考文档。面向“预言机（Oracle）”的 Solidity API 参考：列出公开函数签名、事件、错误、常量、 struct 等。- 为审计、对接、脚本编写提供离线接口手册，和源码保持一一对应与同步。
* proxy - 这批 Markdown 文档是自动生成的，不是人工逐篇写的。项目使用文档生成插件（通过 npm run doc 调用 npx hardhat docgen ）把与代理合约相关的代码导出为“Solidity API”参考文档。面向“代理（Proxy）与其管理合约”的 Solidity API 参考：列出公开函数签名、事件、错误、常量、 struct 等。
* README.md 项目总览与产品介绍：目标、策略理念、已集成的 DeFi 乐高、风险控制（如 Liquidation Protection）。 架构图与背景材料：帮助读者快速理解系统设计与模块关系。 用途：对外说明、团队内部沟通、审计入门背景、文档导航。
* storage-compatibility.md 存储布局兼容性记录：逐版本列出关键合约（如 Vault 、策略合约）的存储槽位（slot）对应关系与变化。用途：升级前后核对 Proxy 合约的存储安全，避免变量重排导致的状态破坏；审计与发布评审的重要依据。

### 🧱 `contracts` 目录说明（类比 Web 世界）

在 Solidity 项目中，`contracts` 目录相当于 **Web 后端的“业务逻辑层 + 控制层”**。  
这里的每个文件或子目录都定义了系统核心功能的智能合约，实现资金流、治理逻辑、策略调用与资产管理。

### 简易目录说明
* flashloan 闪电贷合约目录
* governance 治理合约目录
* hooks 钩子合约目录
* router 路由合约目录
* strategies 策略合约目录
* Constants.sol 常量合约，定义项目常量，如地址、选择器、参数等。
* EmptySlot.sol 空槽合约，用于填充合约字节码，避免合约字节码长度变化导致的问题。
* GovernableOwnable.sol 治理合约，定义项目治理机制，如升级、暂停、恢复等。
* MultiCommand.sol 多命令合约，用于批量执行多个交易。
* MultiStrategy.sol 多策略合约，用于批量执行多个策略。
* MultiStrategyVault.sol 多策略合约，用于存储多策略合约的资产。
* Vault.sol 保险库合约
* VaultBase.sol 保险库合约基础类，定义保险库合约的公共函数和状态变量。
* VaultRegistry.sol 保险库合约注册目录，用于存储所有保险库合约的地址。
* VaultRouter.sol 保险库合约路由目录，用于路由用户交易到不同的保险库合约。
* VaultSettings.sol 保险库合约设置目录，用于存储保险库合约的设置参数。

### 详细目录说明
| 文件 / 目录 | 功能说明 | 🌍 Web 世界类比 | 一句话总结 |
|--------------|-----------|----------------|--------------|
| **flashloan/** | 闪电贷合约目录，当前实现以 **BalancerFlashLender.sol** 为主，提供即时借贷接口；兼容 AAVE 接口标准（位于 `interfaces/aave/`）。 | ⚡ 临时资金池 / 即时交易引擎 | 实现“借→用→还”在同一交易完成的闪电贷逻辑。 |
| **governance/** | 治理合约目录，定义项目的参数与权限治理机制。实际合约升级由 `proxy/` 下的 `BakerFiProxy` 与 `BakerFiProxyAdmin` 执行。 | 🧭 管理后台与权限控制中心 | 管理合约权限、参数和治理结构。 |
| **hooks/** | 钩子合约目录，用于在特定操作（存取款、策略切换等）前后执行自定义逻辑。 | 🪝 中间件 / 事件钩子系统 | 让系统逻辑具备扩展与回调能力。 |
| **router/** | 命令路由目录，主要包含 `Commands.sol`（命令标识库）；真正的交易路由合约位于 `VaultRouter.sol`。 | 🚦 API 网关 / 命令解析层 | 提供指令路由与 Vault 交互桥梁。 |
| **strategies/** | 策略合约目录，定义资产如何运作（AAVE 借贷、Curve 提供流动性、套利等）。 | 🧠 投资策略模块 / 业务算法层 | 让资产“生钱”的核心逻辑所在。 |
| **Constants.sol** | 定义系统级常量（如 `PERCENTAGE_PRECISION`、`MAX_LOAN_TO_VALUE`、`MAX_LOOPS`、`ETH` 及角色常量 `ADMIN_ROLE`、`PAUSER_ROLE`、`VAULT_MANAGER_ROLE`）。不包含函数选择器。 | 🧱 全局常量定义文件 | 项目范围内共享的静态参数与角色标识。 |
| **EmptySlot.sol** | 保留存储槽位，确保可升级合约的存储布局兼容。 | 🧩 编译占位 / 版本兼容控制 | 避免升级时存储结构错乱。 |
| **GovernableOwnable.sol** | 定义双角色治理模型（`owner` 与 `governor`），提供 `onlyGovernor` 修饰器。 | 🔐 权限与治理控制 | 管理系统的治理者与所有者角色。 |
| **MultiCommand.sol** | 批量执行多个交易命令，减少链上交互次数与 Gas 消耗。 | 🧰 批处理脚本执行器 | 一次性执行多个操作。 |
| **MultiStrategy.sol** | 管理多个策略的聚合层，负责将资产按比例分配至不同策略，并执行再平衡。 | 🤖 策略调度中心 | 统筹多种收益策略的自动分配。 |
| **MultiStrategyVault.sol** | 多策略资产金库，集中存储和管理多个策略的资产，并计算收益分配。 | 🏦 资金托管中心（多理财产品资产池） | 汇总所有策略资金的核心金库。 |
| **Vault.sol** | 标准保险库（Vault）合约，实现资产存取与收益结算逻辑。 | 💰 用户资产账户 / 银行账户核心逻辑 | 资金进出与收益分配的核心入口。 |
| **VaultBase.sol** | Vault 基类，封装保险库的公共函数与状态变量；通过 `AccessControl` 管理 `PAUSER_ROLE` 来实现暂停/恢复功能。 | 🧩 抽象基类 / 通用账户逻辑 | Vault 系列的通用底层模板与控制点。 |
| **VaultRegistry.sol** | 保险库注册表，保存系统中所有 Vault 的地址信息；并定义常量（如 `FLASH_LENDER_CONTRACT`、`VAULT_ROUTER_CONTRACT`）用于地址解析。 | 📇 注册中心 / 服务发现目录 | 追踪系统中所有 Vault 的登记与索引。 |
| **VaultRouter.sol** | Vault 路由合约，负责将用户交易请求路由至对应的 Vault。 | 🚦 API 网关 / 请求分发层 | 连接用户入口与金库的调度中心。 |
| **VaultSettings.sol** | 保险库配置模块，存储 Vault 的参数设定，如费率、限制、策略比例；内部提供 `_set*` 方法供受控更新。 | ⚙️ 参数配置中心 / 运行时设置模块 | 动态调整金库运行参数。 |

---


📘 **一句话总结**

> `contracts/` 是整个系统的 **核心逻辑层（Core Logic Layer）**：  
> - Vault 系列：**存钱、算账、分钱**  
> - Strategy 系列：**拿钱、运作、赚钱**  
> - Router 系列：**连接前端与金库**  
> - Governance 系列：**掌控权限与安全**  
> - Flashloan / Hooks：**增强执行能力与可扩展性**

---


### 🧱 `constants` 目录说明（类比 Web 世界）
在 Web3 项目中，`constants` 目录就像 **“后端服务器的配置中心”**。  
每个文件都对应现实世界里服务器运行所需的一部分信息：  
有的管“IP 地址表”，有的管“环境参数”，有的定义“接口路径”或“配置文件格式”。

---

| 文件 | 功能说明 | 🌍 Web 世界类比 | 🧩 在系统中的作用 |
|------|-----------|----------------|------------------|
| **contracts.ts** | 定义：如果我在 X 网络运行这个策略，相关合约都部署在哪个地址。<br>换句话说，它是每个网络上智能合约的部署地址表。 | 🌐 **服务器 IP 地址表**（告诉系统服务都部署在哪） | 决定 **“在哪里运行”** |
| **network-deploy-config.ts** | 定义：运行时要连接哪条链、使用哪些依赖地址、采用什么运行参数（如路由、喂价、借贷市场等）。 | ⚙️ **服务器运行参数说明书**（启动环境配置） | 决定 **“怎么运行”** |
| **pyth.ts** | 定义：告诉系统去哪里查价格，每种喂价（ETH/USD、wstETH/USD 等）对应哪个 feedId。 | 🗺️ **服务器资源路径 / 数据页码链接**（API endpoint 索引） | 决定 **“去哪查数据”** |
| **selectors.json** | 定义：整个项目所有合约函数的 selector 映射表。<br>用于安全审计、模糊测试、漏洞验证。<br>通常由工具自动生成（ABI → 批量计算 selector → 输出 JSON）。 | 🔍 **接口路由映射表 / 安全扫描地图** | 决定 **“能调用哪些函数”** |
| **test-accounts.ts** | 定义：测试或预发布网络使用的一批固定账户（地址 + 私钥）。<br>用于模拟部署者、策略管理员、普通用户、治理投票者等身份。 | 👥 **预发布测试账号配置文件**（模拟用户与角色登录信息） | 决定 **“谁来操作”** |
| **types.ts** | 定义：全局类型与结构规则，描述项目在不同网络下的部署配置、市场类型、预言机配置、策略实现等。<br>是部署、测试和配置文件的“骨架标准”。 | 📘 **服务器配置文件的格式规范书**（Schema / Blueprint） | 决定 **“所有配置文件要长什么样”** |

---


## 概念词典
* 语言机，智能合约系统与现实世界之间的桥梁，本质上是多个节点投票共识的数据返回接口API
* 喂价（feeding），把数据送到链上，提供数据。
* 用价（consuming），智能合约读取这些数据，使用数据。
* 保险库（vault ），负责存储和管理资产的智能合约，接受存入代币，然后把资金交给底层策略取运作（放贷、挖矿、质押、套利），最后把收益按照比例分给用户。