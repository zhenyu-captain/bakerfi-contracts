# 阶段1：系统认知与假设（模型与范围）

定位：承接阶段2/阶段3的模板与证据需求，倒推出统一的系统认知与假设层，为可验证模型（结构/权限/价值流/不变量）提供人类可读的基线描述与边界约束。

- 目标：
  - 为阶段2的 Facts/Assertions/Evidence 提供一致的语义源头与上下文。
  - 为阶段3的 LATER × 标准编号 × 证据聚合提供稳定映射的基线。
  - 不引入新工具与产物，仅输出认知文档与最小模型描述。

- 方法：
  - 以四维体系（Structure/Authority/Value/Invariants）为主轴，映射到 LATER（L/A/T/E/R）。
  - 以仓库实际模块与目录为边界，避免虚构与过度抽象。
  - 所有断言在阶段1仅为“概念不变量”，其可复验证据留待阶段2产出。

---

## 系统概览（仓库与模块）
- 仓库：`bakerfi-contracts`
- 参考图：`doc/architecture.png`
- 核心模块（与路径）：
  - `Vault`（`contracts/core/Vault.sol`）：金库会计、份额发行、资产持有与投资。
  - `VaultRouter`（`contracts/core/VaultRouter.sol`）：用户入口/批量操作路由，参数与权限校验。
  - `MultiStrategy`（`contracts/core/MultiStrategy.sol`）：策略组合管理与再平衡，资产分配规则。
  - `MultiCommand`（`contracts/core/MultiCommand.sol`）：批处理命令原子执行（全成/全败）。
  - `Proxy`（`contracts/proxy/BakerFiProxy.sol`）：合约升级与治理，初始化与槽位兼容。
  - `Oracles`（`contracts/oracles/*`）：价格/比率预言机（如 `PythOracle.sol`, `RatioOracle.sol`）。
  - `Libraries`（`contracts/libraries/*`）：通用数值/交换/协议集成工具。

- 测试与脚本：
  - 测试：`test/*`（vault/strategies/oracles/proxy/hooks 等覆盖）。
  - 升级脚本：`scripts/upgrade-*.ts`（升级与回滚流程记录）。
  - 工具配置：`slither.config.json`、`echidna.yaml` 等。

---

## 资产与会计口径（Value 视角 → LATER:A）
- 资产定义：
  - `held`（金库直接持有资产）+ `invested`（委托策略持有资产）= `totalAssets`。
  - 发行份额 `totalShares` 与 `pricePerShare = totalAssets / totalShares`（单位需统一）。
- 资金入口/出口：
  - 入口：`deposit`、（可能）`flashloan` 与管理操作注入。
  - 出口：`withdraw`、策略赎回、费用提取与升级迁移。
- 费用与会计：
  - 费用记账口径需与份额/资产保持一致（例如管理费、业绩费）。
  - 计价单位与精度需在各模块 Facts 内明确。

---

## 角色与权限（Authority/Trust → LATER:T/E）
- 角色边界：
  - `Owner/Admin/Governance`：可配置与升级权限，权限最小化原则。
  - `ProxyAdmin`：负责实现合约的升级与回滚，保证槽位兼容与初始化幂等。
  - `Strategist`：策略参数与再平衡权责按最小授权控制。
  - `Router`：用户入口的参数校验与跨模块调用的守恒语义。
  - `User`：进行 `deposit/withdraw` 等操作的外部账户。
- 信任来源（Trust）：
  - 预言机数据源（如 Pyth/Chainlink/Ratio）：新鲜度/延迟/单位精度需设定可接受阈值。
  - 外部协议集成（Aave/Curve/Balancer/Lido/Uniswap 等）：假设其合约遵守公开接口与基本安全属性。
  - 管理员密钥与操作流程：密钥托管与变更需可审计，避免单点信任滥用。

---

## 价值流视图（Value Flow → LATER:A）
- 主要流程：
  - `deposit`：用户 → Router → Vault（持有/投资）→ 策略（资产分配）。
  - `withdraw`：用户 ← Router ← Vault（赎回/持有）← 策略（资产回流）。
  - `rebalance`：策略间资产再分配，事件与余额需保持一致性。
  - `batch(MultiCommand)`：多个操作的原子序列，失败整体回滚。
- 辅助流程：
  - `upgrade`：Proxy 切换实现合约，需记录版本与选择器集合变化。
  - `oracle update`：价格/比率更新，需满足新鲜度与单位一致性要求。

---

## 概念不变量（Invariants → 阶段1草案）
- 资产守恒：`totalAssets >= 0`；`totalAssets == sum(held + invested)`。
- 单调性：`pricePerShare` 在无损事件下应单调非负；若发生费用或已实现损失，需在事件中明确记账原因。
- 事件一致性：关键事件（deposit/withdraw/rebalance）与余额变化一致；日志可追溯。
- 批处理原子性：批处理要么全部成功要么整体回滚，不存在部分成功的终态。
- 升级安全：`initialize()` 仅一次；升级不破坏关键槽位；版本标签与选择器集合一致性。
- 预言机新鲜度与单位：数据延迟/精度在阈值内；异常输入能触发回滚或保护机制。

注：以上为阶段1的“语义断言”，在阶段2中以测试断言/Echidna Harness/静态分析报告等产出为 Evidence 进行复验与归档。

---

## 攻击面与风险概览（Standards Seeds）
- 重入与资金错记：SWC-107（Reentrancy/Accounting）；需在 `deposit/withdraw/rebalance` 关键路径验证。
- 升级与初始化风险：SWC-112；`initialize` 幂等与槽位兼容验证。
- 预言机操纵/延迟：SWC-116；新鲜度/极值/单位精度保护。
- 调用顺序与原子性：SWC-128；批处理全成/全败与回滚边界。
- 权限集中与越权：SWC-124；角色最小化与授权路径校验。

说明：上述标准编号在阶段2的条目中以 BF ID 记录证据与命令，在阶段3进行聚合与报告。

---

## 验证输入准备（面向阶段2）
- Facts（结构事实）：
  - 模块边界、外部依赖与会计定义（参考 `audits/stage2/system_structure.md`）。
- Assertions（行为断言）：
  - 以上概念不变量对应的具体测试断言或 Harness。
- Evidence（工具证据）：
  - 测试/覆盖率/静态分析/图谱/不变量与 Gas 报告的输出路径与复验命令。
- Mapping（标准映射）：
  - 在阶段2文档的“标准映射记录”表内维护模块与维度标签。

---

## 目录与路径对照（不新增产物）
- 阶段2归档：`audits/stage2/*`（evidence/slither/graphs/invariants/gas/findings）。
- 文档索引：`audits/stage2/stage2_index.md`（总览与完成状态）。
- 信任来源：`audits/stage2/trust_sources.md`（外部依赖与假设清单）。

---

## 命名与映射（对齐阶段2/阶段3）
- BF 统一编号：`BF-{module}-s2-{later}-{topic}-{index}`（阶段3继续沿用主键）。
- 四维到 LATER 映射：Structure→L；Value→A；Authority/Trust→T/E；Runtime/Batch/Upgrade→R。
- 用语规范：
  - Facts：is/has/depends on（客观陈述）。
  - Assertions：must/should/shall not（约束条件）。
  - Evidence：verified by …（命令与路径）。

---

## 边界与不做事项（阶段1约束）
- 不输出新的工具配置或额外目录；仅维护认知与模型描述。
- 不给出定量参数的最终数值（如 `epsilon`），在阶段2中以测试阈值/单位说明具体化。
- 不复验任何断言与证据；所有复验工作在阶段2进行并归档。

---

## 快速起步（面向阶段2的最小行动）
- 运行：`npx hardhat test`；`npx hardhat coverage`；`slither . --config-file slither.config.json`。
- 为 `vault/proxy/oracles` 各登记至少 1–2 条 BF 条目（资产守恒/初始化幂等/新鲜度精度）。
- 将测试与分析输出归档到 `audits/stage2/evidence/*` 并在阶段2文档条目中填写路径与命令。

---

## 结语
- 阶段1以“统一认知与假设”为核心，服务阶段2的可验证产出与阶段3的聚合展示。当前文档与仓库结构保持一致性与可操作性，避免过度抽象，后续仅需在阶段2按模板填充事实、断言与证据。