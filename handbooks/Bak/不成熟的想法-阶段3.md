# 阶段3：宏观维度与标准/工具/报告落地

目标：在已完成的结构/资金流/权限/不变量基础上，叠加宏观视角与行业标准，并用工具验证与报告闭环固化成果，形成可复验、可聚合的审计产物。

## L-A-T-E-R 宏观维度
- Layers（分层）：合约层级、模块边界、外部依赖与信任边界。
- Assets（资产）：金库总资产、策略资产、用户余额、费用与会计口径。
- Threats & Trust（威胁与信任）：重入、授权、输入、价格源、批处理、升级等攻击面；第三方协议/预言机的信任假设。
- Economics/Invariants（经济与不变量）：份额价格单调、资金守恒、策略边界、初始化一次性与升级幂等、事件/余额一致性。
- Responses/Runbooks（响应与作战手册）：监控指标、关键事件、异常响应与回滚流程（动作→前置→后置→监控/事件→回滚）。

## 行业标准维度（聚合映射）
- SWC（Smart Contract Weakness Classification）：重入、授权、算术、delegatecall、存储写入等条目与函数/模块绑定。
- DASP（Decentralized Application Security Project）：访问控制、竞态、整数处理、意外回退等风险分类对照。
- OWASP（相关性）：输入校验、鉴权与会话管理、日志与监控等通用安全控制。
- SCSVS（Smart Contract Security Verification Standard）：访问控制、交易原子性、资产会计、升级/存储兼容、预言机新鲜度/偏差控制。
- 产出：将上述条目映射到模块/函数与验证脚本，形成可查询的标准标签与证据索引。

## 工具验证维度（执行落地）
- 静态分析（Slither/Surya/Semgrep）：调用图、权限矩阵、可疑模式规则扫描；输出 JSON/图谱用于后续聚合。
- 测试与覆盖（Hardhat + solidity-coverage）：跑通 `test/*`，建立覆盖率与关键路径证据（事件/余额/行覆盖）。
- 不变量/符号（Echidna/Mythril）：核心不变量绑定（Echidna），关键分支符号执行（Mythril）用于升级/授权/批处理路径验证。
- 性能与DoS观测（hardhat-gas-reporter）：记录 gas 边界与潜在拒绝服务风险点。

## 报告与修复验证（Mitigation Review）
- 报告字段统一：`severity/impact/layer/status/tags/repro/evidence/mitigation/validation-evidence/owner/version`。
- 复现与证据：最小 PoC 步骤、交易/事件/余额/槽位对照、覆盖率与图谱快照。
- 修复与二次验证：提交补丁后，重跑静态/测试/不变量，更新 `status` 为 `validated` 并附二次证据。
- 聚合输出：支持 Markdown 与 JSON 双格式，便于比对多轮审计与自动化管线接入。

## 产物与交付
- 标准映射清单：SWC × SCSVS × 场景风险三合一索引与证据链接。
- 工具产出归档：静态分析报告、测试覆盖率、Echidna 不变量结果、Mythril 路径分析、Gas 报告。
- 运营与升级证据链：`scripts/tasks/*` 操作记录与 `scripts/upgrade-*.ts` 升级/回滚证据链。
- 验收：按模块与不变量逐项核对，`status=open/mitigated/validated` 透明化跟踪。

---

## 三元映射（层面 × 标准 × 工具产出）

目的：每个“问题”都应当在三个维度上被明确——
- 宏观维度（L-A-T-E-R）= 我在看什么层面的问题（结构/资产/权限/预言机/批处理/代理…）。
- 行业标准维度（SWC/DASP/SCSVS）= 我如何描述或编号这个问题（统一标签与编号）。
- 工具产出维度（Slither/Surya/Hardhat/Echidna/Mythril/Gas）= 我用什么手段验证或证明这个问题（证据与可复验路径）。

映射规则：
- 每个发现必须至少绑定 1 个 L-A-T-E-R 层面、1 个标准编号（SWC 或 SCSVS），以及 1 个工具产出（命令与文件）。
- 证据应可复现：包含最小 PoC 步骤与产物路径（事件/余额/图谱/覆盖率/槽位）。

## 问题卡片模板（可复制）

- id: `BF-{module}-{layer}-{std}-{index}`（例如：`BF-vault-asset-SWC-128-001`）
- title: 问题标题（简短、动词+名词）
- layer: `structure | asset | permission | oracle | batch | proxy`
- standards: `[SWC-xxx, SCSVS-yyy, DASP-zzz]`
- repro: 最小复现步骤（命令/脚本/测试名）
- evidence:
  - tx/events/balances: 交易哈希、关键事件、余额对照
  - graph/matrix: 调用图/权限矩阵（Surya/Slither 输出）
  - coverage: 覆盖率片段（hardhat-coverage）
  - slots/version: 代理槽位、版本/选择器比对
- tools: `[slither, surya, hardhat, echidna, mythril, gas-reporter]`
- severity: `critical | high | medium | low | info`
- impact: 简述影响面（资产、可用性、完整性、升级风险）
- mitigation: 修复建议或补丁概要
- validation-evidence: 修复后二次证据（同 evidence 字段）
- owner/version: 责任人与版本标签
- status: `open | mitigated | validated`

## 编号与命名规则

- 模块缩写：`vault | router | strategy | command | oracle | proxy | settings | registry`
- 层面缩写：`structure | asset | permission | oracle | batch | proxy`
- 标准：优先 SWC（如 `SWC-107`），无对应时使用 SCSVS 控制项（如 `SCSVS-Atomicity`）。
- 示例：`BF-vault-asset-SWC-128-001`、`BF-proxy-permission-SCSVS-AccessControl-002`。

## 模块示例映射（三元视角）

- Vault（`contracts/core/Vault.sol`）
  - layer: `asset`
  - standards: `[SWC-128, SCSVS-Atomicity]`
  - tools:
    - slither: `slither . --config-file slither.config.json`
    - hardhat: `npx hardhat test test/core/vault/*`
    - coverage: `npx hardhat coverage`
    - gas: `npm run test`（集成 gas reporter）
  - evidence: 事件（Deposit/Withdraw）、`totalAssets/pricePerShare` 单调、覆盖率行号与图谱快照。

- VaultRouter（`contracts/core/VaultRouter.sol`）
  - layer: `batch | permission`
  - standards: `[SWC-115, SCSVS-InputValidation]`
  - tools:
    - surya graph: `surya graph contracts/core/VaultRouter.sol --output audits/stage3/graphs/vault-router.dot`
    - hardhat: `npx hardhat test test/core/vault/*`
  - evidence: 参数边界触发回滚、事件与金额一致、调用图与权限矩阵。

- MultiStrategy（`contracts/core/MultiStrategy.sol`）
  - layer: `asset`
  - standards: `[SWC-107, SCSVS-AssetAccounting]`
  - tools: hardhat `test/core/strategies/*`、Echidna 不变量 `Invariant_StrategyBounds`。
  - evidence: 分配与总资产一致、再平衡事件与余额对照。

- MultiCommand（`contracts/core/MultiCommand.sol`）
  - layer: `batch`
  - standards: `[SWC-114, SWC-128, SCSVS-Atomicity]`
  - tools: hardhat `test/hooks/*`、Echidna `Invariant_BatchAtomicity`。
  - evidence: 全成/全败语义、事件顺序与最终余额一致。

- Oracles（`contracts/oracles/*`）
  - layer: `oracle`
  - standards: `[SWC-116, SCSVS-OracleFreshness/Deviation]`
  - tools: hardhat `test/oracles/*`、Echidna `Invariant_OracleGuardrails`。
  - evidence: 极值/延迟触发保护、单位与小数位一致性。

- Proxy（`contracts/proxy/BakerFiProxy.sol`）
  - layer: `proxy | permission`
  - standards: `[SWC-112, SWC-124, SCSVS-Upgrade/StorageCompatibility]`
  - tools: hardhat `test/proxy/*`、`scripts/upgrade-*.ts` 升级证据链、Mythril 关键路径。
  - evidence: 槽位 Diff、初始化事件唯一、选择器比对与版本标签。

## 证据归档规范与路径建议

- 报告与卡片：`audits/stage3/findings/{id}.md` 与 `{id}.json`
- 图谱与矩阵：`audits/stage3/graphs/*.dot|*.png`（Surya/Slither 输出）
- 覆盖率：`coverage/`（Hardhat 覆盖报告目录）
- 不变量结果：`audits/stage3/invariants/*.txt`（Echidna 输出摘要）
- 升级证据链：`audits/stage3/upgrades/{version}/slots-diff.md`、`tx.log`、`selectors.json`
- Mythril 分析：`audits/stage3/mythril/{module}-{path}.json`

## 最小命令清单（落地执行）

- 静态分析：`slither . --config-file slither.config.json`
- 调用图：`surya graph contracts/core/Vault.sol --output audits/stage3/graphs/vault.dot`
- 测试：`npx hardhat test`
- 覆盖率：`npx hardhat coverage`
- 不变量：`echidna-test . --config echidna.yaml`
- 符号执行（按需）：`myth analyze contracts/proxy/BakerFiProxy.sol -o json -t 300`（示例）

## 输出与验收（与“报告与修复验证”对齐）

- 统一字段：沿用上节的 `severity/impact/layer/status/tags/repro/evidence/mitigation/validation-evidence`。
- 最小验收：每个发现至少提供 1 个复现命令 + 1 组证据（事件/余额/图谱/覆盖片段）+ 标准标签。
- 修复闭环：补丁后二次验证与状态更新为 `validated`，并归档到 `audits/stage3/findings/*`。